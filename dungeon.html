<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dungeon Crawler - D&D Adventure</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a0f;color:#e0e0e0;font-family:'Cinzel',serif;overflow:hidden;height:100vh}
#bg-particles{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none}
.back-btn{position:fixed;top:18px;left:24px;color:#aaa;text-decoration:none;font-size:14px;z-index:100;font-family:'Cinzel',serif;transition:color .3s}.back-btn:hover{color:#fff}
h1.title{font-family:'Cinzel',serif;font-weight:900;font-size:22px;text-align:center;padding:10px 0 6px;z-index:2;position:relative;text-shadow:0 0 20px rgba(180,140,60,.5);color:#f1c40f;letter-spacing:2px}
#app{position:relative;z-index:2;display:flex;height:calc(100vh - 46px);gap:0;overflow:hidden}
#main-col{flex:1;display:flex;flex-direction:column;padding:8px 12px;overflow:hidden;min-width:0}
#narrative-box{flex:1;overflow-y:auto;border-radius:10px;padding:20px 24px;font-family:'Crimson Text',serif;font-size:17px;line-height:1.7;color:#d4c8a0;position:relative;
  background:linear-gradient(135deg,rgba(30,25,18,.92),rgba(20,16,10,.95));
  border:1px solid rgba(180,140,60,.2);box-shadow:inset 0 0 60px rgba(0,0,0,.5),0 0 30px rgba(0,0,0,.4)}
#narrative-box::-webkit-scrollbar{width:8px}
#narrative-box::-webkit-scrollbar-track{background:rgba(0,0,0,.3);border-radius:4px}
#narrative-box::-webkit-scrollbar-thumb{background:rgba(180,140,60,.3);border-radius:4px}
.dm-text{margin-bottom:12px;animation:fadeIn .5s ease}
.dm-text em{color:#c9a84c;font-style:italic}
.dm-text strong{color:#e8d5a3}
.dm-label{color:#f1c40f;font-family:'Cinzel',serif;font-size:13px;font-weight:700;margin-bottom:4px;display:block}
.roll-result{text-align:center;font-family:'Cinzel',serif;font-size:15px;color:#8cf;margin:8px 0;padding:8px;background:rgba(0,0,0,.3);border-radius:6px;border:1px solid rgba(100,160,255,.15)}
.roll-result .die-val{font-size:28px;color:#f1c40f;display:inline-block;animation:diceRoll .4s ease}
.combat-hit{color:#e74c3c;font-weight:600}
.combat-miss{color:#888;font-style:italic}
.combat-heal{color:#2ecc71;font-weight:600}
.loot-text{color:#f1c40f;font-weight:600}
.xp-text{color:#8cf}
.gold-text{color:#f1c40f}
#choices{padding:10px 0 4px;display:flex;flex-wrap:wrap;gap:8px;min-height:44px}
#choices button{font-family:'Cinzel',serif;font-size:13px;padding:8px 18px;border-radius:6px;border:1px solid rgba(180,140,60,.3);background:linear-gradient(135deg,rgba(40,35,20,.9),rgba(30,25,15,.95));color:#d4c8a0;cursor:pointer;transition:all .2s;flex:1;min-width:140px;max-width:320px}
#choices button:hover{background:linear-gradient(135deg,rgba(60,50,25,.95),rgba(45,38,20,.98));border-color:rgba(241,196,15,.5);color:#f1c40f;box-shadow:0 0 12px rgba(241,196,15,.15);transform:translateY(-1px)}
#log-box{height:100px;overflow-y:auto;margin-top:6px;border-radius:8px;padding:8px 12px;font-family:'Crimson Text',serif;font-size:13px;line-height:1.5;color:#8a8a7a;
  background:rgba(10,10,15,.8);border:1px solid rgba(255,255,255,.06)}
#log-box::-webkit-scrollbar{width:6px}
#log-box::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}
.log-entry{margin:2px 0;padding:2px 0;border-bottom:1px solid rgba(255,255,255,.03)}
#sidebar{width:280px;display:flex;flex-direction:column;gap:6px;padding:8px 10px 8px 0;overflow-y:auto;font-size:12px}
#sidebar::-webkit-scrollbar{width:6px}
#sidebar::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:3px}
.panel{background:rgba(10,10,20,.75);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:10px}
.panel h3{font-size:13px;color:#f1c40f;margin-bottom:6px;border-bottom:1px solid rgba(255,255,255,.08);padding-bottom:4px}
.stat-row{display:flex;justify-content:space-between;margin:2px 0;font-size:11px}
.stat-val{color:#8cf}
.bar-outer{width:100%;height:12px;background:rgba(255,255,255,.1);border-radius:6px;overflow:hidden;margin:3px 0}
.bar-inner{height:100%;border-radius:6px;transition:width .4s}
.hp-bar{background:linear-gradient(90deg,#8b0000,#e74c3c)}
.mana-bar{background:linear-gradient(90deg,#1a3a6a,#3498db)}
.xp-bar{background:linear-gradient(90deg,#5a5a10,#f1c40f)}
.equip-slot{font-size:11px;color:#aaa;margin:2px 0;display:flex;justify-content:space-between}
.equip-slot .item-name{color:#d4a;max-width:170px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.inv-item{font-size:11px;color:#bbb;margin:1px 0;cursor:default}
.quest-item{font-size:11px;margin:3px 0;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.quest-item .q-name{color:#f1c40f}
.quest-item .q-desc{color:#888;font-size:10px}
.quest-done{text-decoration:line-through;opacity:.5}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes diceRoll{0%{transform:rotateZ(0) scale(1)}25%{transform:rotateZ(15deg) scale(1.2)}50%{transform:rotateZ(-10deg) scale(1.3)}75%{transform:rotateZ(5deg) scale(1.1)}100%{transform:rotateZ(0) scale(1)}}
@keyframes pulseGlow{0%,100%{text-shadow:0 0 8px rgba(241,196,15,.3)}50%{text-shadow:0 0 20px rgba(241,196,15,.6)}}

/* Character Creation - Parchment Style */
#char-create{max-width:620px;margin:0 auto;padding:30px 36px;
  background:linear-gradient(145deg,#d4c8a0,#c4b48a,#d4c8a0);
  border-radius:4px;border:2px solid #8b7355;
  box-shadow:0 0 30px rgba(0,0,0,.6),inset 0 0 40px rgba(139,115,85,.2);
  color:#2c1810;position:relative;font-family:'Crimson Text',serif}
#char-create::before{content:'';position:absolute;top:8px;left:8px;right:8px;bottom:8px;
  border:1px solid rgba(139,115,85,.3);border-radius:2px;pointer-events:none}
#char-create h2{font-family:'Cinzel',serif;font-weight:900;color:#2c1810;text-align:center;margin-bottom:6px;font-size:24px;
  text-shadow:1px 1px 0 rgba(212,200,160,.5);letter-spacing:3px}
#char-create .sheet-subtitle{text-align:center;color:#5a4a3a;font-size:12px;font-family:'Cinzel',serif;margin-bottom:18px;
  border-bottom:2px solid #8b7355;padding-bottom:10px;letter-spacing:1px}
#char-create label{display:block;color:#5a4a3a;margin:12px 0 4px;font-size:13px;font-family:'Cinzel',serif;font-weight:700;letter-spacing:1px}
#char-create input[type=text]{width:100%;padding:8px 12px;border-radius:2px;border:1px solid #8b7355;
  background:rgba(255,250,240,.6);color:#2c1810;font-family:'Cinzel',serif;font-size:15px;
  box-shadow:inset 0 1px 3px rgba(0,0,0,.1)}
#char-create input[type=text]:focus{outline:none;border-color:#5a3a1a;box-shadow:inset 0 1px 3px rgba(0,0,0,.15),0 0 6px rgba(180,140,60,.3)}
#char-create input[type=text]::placeholder{color:#9a8a7a}
#char-create .class-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
.class-card{padding:12px 10px;border-radius:4px;border:2px solid #a89878;background:rgba(255,250,240,.5);
  cursor:pointer;text-align:center;transition:all .2s;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.class-card:hover{border-color:#5a3a1a;background:rgba(255,250,240,.8);transform:translateY(-1px);box-shadow:0 3px 8px rgba(0,0,0,.15)}
.class-card.selected{border-color:#2c1810;background:rgba(241,196,15,.2);box-shadow:0 0 10px rgba(180,140,60,.3)}
.class-card .cc-icon{font-size:28px;display:block;margin-bottom:4px}
.class-card .cc-name{color:#2c1810;font-size:14px;font-weight:700;font-family:'Cinzel',serif}
.class-card .cc-desc{color:#6a5a4a;font-size:11px;margin-top:2px}

/* Stat Assignment Area */
.stat-mode-toggle{display:flex;gap:8px;margin:10px 0}
.stat-mode-btn{flex:1;padding:8px;border:2px solid #a89878;border-radius:4px;background:rgba(255,250,240,.4);
  color:#5a4a3a;font-family:'Cinzel',serif;font-size:12px;font-weight:700;cursor:pointer;text-align:center;transition:all .2s}
.stat-mode-btn:hover{border-color:#5a3a1a;background:rgba(255,250,240,.7)}
.stat-mode-btn.active{border-color:#2c1810;background:rgba(241,196,15,.25);color:#2c1810}
.points-remaining{text-align:center;font-family:'Cinzel',serif;font-size:16px;font-weight:700;color:#2c1810;
  margin:8px 0;padding:8px;background:rgba(139,115,85,.1);border-radius:4px;border:1px solid #a89878}
.points-remaining span{color:#8b0000;font-size:20px}
#stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:8px 0}
.stat-assign-row{display:flex;align-items:center;padding:6px 10px;background:rgba(255,250,240,.4);border-radius:4px;
  border:1px solid #a89878;gap:6px}
.stat-assign-row .sa-name{font-family:'Cinzel',serif;font-size:12px;font-weight:700;color:#5a4a3a;width:50px}
.stat-assign-row .sa-val{font-family:'Cinzel',serif;font-size:18px;font-weight:700;color:#2c1810;min-width:28px;text-align:center}
.stat-assign-row .sa-mod{font-size:11px;color:#6a5a4a;min-width:30px;text-align:center}
.stat-assign-row button{width:24px;height:24px;border:1px solid #8b7355;border-radius:3px;
  background:rgba(255,250,240,.6);color:#2c1810;font-size:14px;font-weight:700;cursor:pointer;
  display:flex;align-items:center;justify-content:center;transition:all .15s;padding:0;line-height:1}
.stat-assign-row button:hover{background:rgba(241,196,15,.3);border-color:#5a3a1a}
.stat-assign-row button:disabled{opacity:.3;cursor:not-allowed}
.stat-assign-row .sa-dice{font-size:10px;color:#6a5a4a;margin-left:auto}

#start-btn{display:block;width:100%;padding:12px;margin:16px 0 4px;border-radius:4px;
  border:2px solid #5a3a1a;background:linear-gradient(135deg,#8b7355,#6a5a3a);
  color:#f5e6c8;font-family:'Cinzel',serif;font-size:16px;font-weight:900;cursor:pointer;
  transition:all .2s;letter-spacing:2px;text-shadow:0 1px 2px rgba(0,0,0,.3);
  box-shadow:0 2px 8px rgba(0,0,0,.3)}
#start-btn:hover:not(:disabled){background:linear-gradient(135deg,#9a8365,#7a6a4a);
  box-shadow:0 4px 15px rgba(0,0,0,.4);transform:translateY(-1px)}
#start-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
</style>
</head>
<body>
<a href="index.html" class="back-btn">&larr; Back to Gallery</a>
<canvas id="bg-particles"></canvas>
<h1 class="title">&#9876; Realm of Shadows &#9876;</h1>
<div id="app"></div>
<script>
// ========== PARTICLE BACKGROUND ==========
(function(){
const c=document.getElementById('bg-particles'),x=c.getContext('2d');
function resize(){c.width=innerWidth;c.height=innerHeight}
resize();addEventListener('resize',resize);
const P=[];for(let i=0;i<80;i++)P.push({x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*2+.5,dx:(Math.random()-.5)*.3,dy:(Math.random()-.5)*.3,a:Math.random()*.4+.1});
function draw(){x.clearRect(0,0,c.width,c.height);for(const p of P){x.beginPath();x.arc(p.x,p.y,p.r,0,Math.PI*2);x.fillStyle=`rgba(180,140,60,${p.a})`;x.fill();p.x+=p.dx;p.y+=p.dy;if(p.x<0||p.x>c.width)p.dx*=-1;if(p.y<0||p.y>c.height)p.dy*=-1;}requestAnimationFrame(draw)}
draw();
})();

// ========== WEB AUDIO SOUND EFFECTS ==========
const SFX=(function(){
const ctx=new(window.AudioContext||window.webkitAudioContext)();
function play(type){
try{ctx.resume();
const o=ctx.createOscillator(),g=ctx.createGain();
o.connect(g);g.connect(ctx.destination);
const t=ctx.currentTime;
if(type==='dice'){o.type='square';o.frequency.setValueAtTime(800,t);o.frequency.exponentialRampToValueAtTime(200,t+.15);g.gain.setValueAtTime(.12,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2);}
else if(type==='hit'){o.type='sawtooth';o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(60,t+.2);g.gain.setValueAtTime(.15,t);g.gain.exponentialRampToValueAtTime(.001,t+.25);o.start(t);o.stop(t+.25);}
else if(type==='miss'){o.type='sine';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(150,t+.15);g.gain.setValueAtTime(.06,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2);}
else if(type==='heal'){o.type='sine';o.frequency.setValueAtTime(400,t);o.frequency.exponentialRampToValueAtTime(800,t+.3);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.35);o.start(t);o.stop(t+.35);}
else if(type==='loot'){o.type='sine';o.frequency.setValueAtTime(500,t);o.frequency.exponentialRampToValueAtTime(1000,t+.15);g.gain.setValueAtTime(.08,t);g.gain.exponentialRampToValueAtTime(.001,t+.25);const o2=ctx.createOscillator(),g2=ctx.createGain();o2.connect(g2);g2.connect(ctx.destination);o2.type='sine';o2.frequency.setValueAtTime(700,t+.15);o2.frequency.exponentialRampToValueAtTime(1200,t+.3);g2.gain.setValueAtTime(.08,t+.15);g2.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.25);o2.start(t+.15);o2.stop(t+.4);}
else if(type==='levelup'){o.type='sine';o.frequency.setValueAtTime(400,t);o.frequency.exponentialRampToValueAtTime(600,t+.15);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.08,t+.15);const o2=ctx.createOscillator(),g2=ctx.createGain();o2.connect(g2);g2.connect(ctx.destination);o2.type='sine';o2.frequency.setValueAtTime(600,t+.2);o2.frequency.exponentialRampToValueAtTime(900,t+.4);g2.gain.setValueAtTime(.1,t+.2);g2.gain.exponentialRampToValueAtTime(.001,t+.5);o.start(t);o.stop(t+.2);o2.start(t+.2);o2.stop(t+.5);}
else if(type==='death'){o.type='sawtooth';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(40,t+.6);g.gain.setValueAtTime(.15,t);g.gain.exponentialRampToValueAtTime(.001,t+.7);o.start(t);o.stop(t+.7);}
else if(type==='click'){o.type='sine';o.frequency.setValueAtTime(600,t);g.gain.setValueAtTime(.05,t);g.gain.exponentialRampToValueAtTime(.001,t+.08);o.start(t);o.stop(t+.1);}
}catch(e){}
}
return{play};
})();

// ========== UTILITIES ==========
function d(n){return Math.floor(Math.random()*n)+1}
function d20(){return d(20)}
function roll4d6Drop(){const r=[d(6),d(6),d(6),d(6)];r.sort((a,b)=>a-b);return{rolls:r,total:r[1]+r[2]+r[3]}}
function pick(a){return a[Math.floor(Math.random()*a.length)]}
function clamp(v,mn,mx){return Math.max(mn,Math.min(mx,v))}
function mod(stat){return Math.floor((stat-10)/2)}
function modStr(stat){const m=mod(stat);return m>=0?'+'+m:''+m}

// Point-buy cost: 1 point per level 8-13, 2 points per level 14-15
function pointBuyCost(currentVal, direction){
  if(direction===1){// increasing
    if(currentVal>=15) return Infinity;
    if(currentVal>=13) return 2;
    return 1;
  }else{// decreasing (refund)
    if(currentVal<=8) return 0;
    if(currentVal>13) return 2;
    return 1;
  }
}

// ========== GAME DATA ==========
const CLASS_DATA={
Warrior:{icon:'&#9876;',desc:'Master of arms and armor',hpBase:12,manaBase:0,primaryStat:'str',skills:['Power Strike','Shield Bash','Rally'],equipment:{weapon:'Longsword (+3)',armor:'Chain Mail (AC 16)',shield:'Wooden Shield (+2)'}},
Mage:{icon:'&#9733;',desc:'Wielder of arcane magic',hpBase:6,manaBase:20,primaryStat:'int',skills:['Fireball','Ice Shard','Arcane Shield'],equipment:{weapon:'Oak Staff (+1)',armor:'Cloth Robes (AC 11)',shield:'---'}},
Rogue:{icon:'&#9760;',desc:'Shadow and subtlety',hpBase:8,manaBase:5,primaryStat:'dex',skills:['Backstab','Poison Blade','Vanish'],equipment:{weapon:'Twin Daggers (+2)',armor:'Leather Armor (AC 13)',shield:'---'}},
Cleric:{icon:'&#10010;',desc:'Divine healer and protector',hpBase:8,manaBase:15,primaryStat:'wis',skills:['Heal','Smite','Bless'],equipment:{weapon:'Mace (+2)',armor:'Scale Mail (AC 14)',shield:'Holy Symbol'}}
};

const MONSTER_DATA=[
{name:'Goblin',hp:7,ac:12,atk:3,xp:25,gold:5,tier:1},
{name:'Kobold',hp:5,ac:12,atk:2,xp:15,gold:3,tier:1},
{name:'Giant Rat',hp:4,ac:10,atk:2,xp:10,gold:1,tier:1},
{name:'Skeleton',hp:13,ac:13,atk:4,xp:50,gold:10,tier:1},
{name:'Wolf Pack',hp:11,ac:13,atk:5,xp:40,gold:0,tier:1},
{name:'Bandit',hp:16,ac:14,atk:5,xp:60,gold:15,tier:2},
{name:'Orc Warrior',hp:22,ac:14,atk:7,xp:80,gold:20,tier:2},
{name:'Giant Spider',hp:18,ac:13,atk:6,xp:70,gold:5,tier:2},
{name:'Zombie Horde',hp:30,ac:8,atk:4,xp:65,gold:8,tier:2},
{name:'Wraith',hp:25,ac:15,atk:8,xp:100,gold:0,tier:2},
{name:'Ogre',hp:40,ac:12,atk:10,xp:120,gold:30,tier:3},
{name:'Troll',hp:45,ac:13,atk:9,xp:140,gold:25,tier:3},
{name:'Dark Mage',hp:30,ac:14,atk:11,xp:150,gold:40,tier:3},
{name:'Minotaur',hp:50,ac:15,atk:12,xp:180,gold:35,tier:3},
{name:'Vampire',hp:55,ac:16,atk:11,xp:200,gold:50,tier:4},
{name:'Wyvern',hp:65,ac:15,atk:13,xp:250,gold:45,tier:4},
{name:'Lich',hp:60,ac:17,atk:14,xp:300,gold:80,tier:4},
{name:'Young Dragon',hp:80,ac:18,atk:15,xp:400,gold:100,tier:5},
{name:'Ancient Dragon',hp:120,ac:20,atk:18,xp:600,gold:200,tier:5},
{name:'Demon Lord',hp:100,ac:19,atk:16,xp:500,gold:150,tier:5}
];

const LOOT_WEAPONS=[
{name:'Rusty Sword (+1)',bonus:1,tier:1},{name:'Short Bow (+2)',bonus:2,tier:1},
{name:'War Axe (+3)',bonus:3,tier:2},{name:'Enchanted Blade (+4)',bonus:4,tier:2},
{name:'Flaming Sword (+5)',bonus:5,tier:3},{name:'Vorpal Blade (+6)',bonus:6,tier:3},
{name:'Staff of Thunder (+5)',bonus:5,tier:3},{name:'Shadow Dagger (+4)',bonus:4,tier:2},
{name:'Holy Avenger (+7)',bonus:7,tier:4},{name:'Dragonslayer (+8)',bonus:8,tier:5}
];
const LOOT_ARMOR=[
{name:'Padded Armor (AC 12)',ac:12,tier:1},{name:'Studded Leather (AC 14)',ac:14,tier:2},
{name:'Half Plate (AC 16)',ac:16,tier:3},{name:'Full Plate (AC 18)',ac:18,tier:4},
{name:'Mithril Chain (AC 17)',ac:17,tier:3},{name:'Dragon Scale (AC 19)',ac:19,tier:5}
];

const QUEST_TEMPLATES=[
{name:'Defeat the {monster} of {place}',type:'kill',desc:'A fearsome {monster} terrorizes {place}. Slay it!'},
{name:'Find the Lost {item}',type:'fetch',desc:'The legendary {item} was lost in the wilds. Recover it.'},
{name:'Save the Village of {place}',type:'rescue',desc:'The people of {place} cry for help. Answer their call.'},
{name:'Clear the {place} Dungeon',type:'dungeon',desc:'Dark creatures infest the {place} dungeon. Purge them.'},
{name:'Escort the Merchant to {place}',type:'escort',desc:'A merchant needs safe passage to {place}.'}
];
const Q_MONSTERS=['Dragon','Lich','Ogre King','Vampire Lord','Demon','Troll Chieftain','Wyvern','Dark Sorcerer'];
const Q_PLACES=['Ashenvale','Grimhollow','Thornfield','Ravenspire','Duskwood','Ironforge','Crystalpeak','Shadowmere','Stormhaven','Eldergrove'];
const Q_ITEMS=['Amulet of Ages','Crown of Stars','Sword of Dawn','Orb of Shadows','Ring of Power','Staff of Elements','Tome of Secrets'];

const TOWN_NAMES=['Millhaven','Crossroads Inn','Ironvale','Thornwall','Brightwater','Dunholm','Ashford','Ravensrest'];
const WILDERNESS_DESCS=['a dense, fog-shrouded forest','rocky mountain passes','a vast, windswept plain','murky swamplands','an ancient, crumbling road','a dark ravine','sun-dappled woodland','a frozen tundra'];

// ========== GAME STATE ==========
let G={phase:'create',player:null,quests:[],turn:0,encounter:null,location:'wilderness',combatLog:[],events:0};

// ========== RENDERING ==========
const app=document.getElementById('app');

function renderCreate(){
const STAT_NAMES=['Strength','Dexterity','Constitution','Intelligence','Wisdom','Charisma'];
const STAT_KEYS=['str','dex','con','int','wis','cha'];

app.innerHTML=`<div id="main-col"><div id="narrative-box"><div id="char-create">
<h2>&#9876; Character Sheet &#9876;</h2>
<div class="sheet-subtitle">Realm of Shadows -- Adventurer Registry</div>

<label>Character Name</label>
<input type="text" id="cc-name" placeholder="Enter your name..." maxlength="20" value="">

<label>Choose Your Class</label>
<div class="class-grid">
${Object.entries(CLASS_DATA).map(([k,v])=>`<div class="class-card" data-cls="${k}"><span class="cc-icon">${v.icon}</span><span class="cc-name">${k}</span><div class="cc-desc">${v.desc}</div></div>`).join('')}
</div>

<label>Ability Scores</label>
<div class="stat-mode-toggle">
  <div class="stat-mode-btn active" data-mode="pointbuy">Point Buy (27 pts)</div>
  <div class="stat-mode-btn" data-mode="roll">Roll Random (4d6)</div>
</div>
<div id="points-display" class="points-remaining">Points Remaining: <span id="pts-left">27</span> / 27</div>
<div id="stat-grid"></div>

<button id="start-btn" disabled>&#9876; Start Adventure &#9876;</button>
</div></div></div>`;

let selClass=null;
let statMode='pointbuy';
let stats={str:8,dex:8,con:8,int:8,wis:8,cha:8};
let pointsUsed=0;
const TOTAL_POINTS=27;
let statsAssigned=false;
let rollDice={}; // store dice results for display

function calcPointsUsed(){
  let used=0;
  STAT_KEYS.forEach(k=>{
    const v=stats[k];
    // cost from 8 to current value
    for(let i=8;i<v;i++){
      if(i>=13) used+=2;
      else used+=1;
    }
  });
  return used;
}

function renderStats(){
  const sg=document.getElementById('stat-grid');
  if(!sg)return;
  let html='';
  if(statMode==='pointbuy'){
    const ptsLeft=TOTAL_POINTS-calcPointsUsed();
    document.getElementById('points-display').style.display='block';
    document.getElementById('pts-left').textContent=ptsLeft;
    STAT_KEYS.forEach((k,i)=>{
      const v=stats[k];
      const m=mod(v);
      const mStr=m>=0?'+'+m:''+m;
      const costUp=pointBuyCost(v,1);
      const canInc=v<15 && costUp<=ptsLeft;
      const canDec=v>8;
      html+=`<div class="stat-assign-row">
        <span class="sa-name">${STAT_NAMES[i].substring(0,3).toUpperCase()}</span>
        <button class="stat-dec" data-key="${k}" ${canDec?'':'disabled'}>-</button>
        <span class="sa-val">${v}</span>
        <button class="stat-inc" data-key="${k}" ${canInc?'':'disabled'}>+</button>
        <span class="sa-mod">(${mStr})</span>
      </div>`;
    });
    statsAssigned=(calcPointsUsed()>0);
  }else{
    document.getElementById('points-display').style.display='none';
    STAT_KEYS.forEach((k,i)=>{
      const v=stats[k];
      const m=mod(v);
      const mStr=m>=0?'+'+m:''+m;
      const diceStr=rollDice[k]?`[${rollDice[k].join(', ')}]`:'--';
      html+=`<div class="stat-assign-row">
        <span class="sa-name">${STAT_NAMES[i].substring(0,3).toUpperCase()}</span>
        <span class="sa-val">${v}</span>
        <span class="sa-mod">(${mStr})</span>
        <span class="sa-dice">${diceStr}</span>
      </div>`;
    });
  }
  sg.innerHTML=html;

  // bind +/- buttons for point buy
  if(statMode==='pointbuy'){
    sg.querySelectorAll('.stat-inc').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const key=btn.dataset.key;
        const cost=pointBuyCost(stats[key],1);
        const ptsLeft=TOTAL_POINTS-calcPointsUsed();
        if(stats[key]<15 && cost<=ptsLeft){
          stats[key]++;
          SFX.play('click');
          renderStats();
          checkReady();
        }
      });
    });
    sg.querySelectorAll('.stat-dec').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const key=btn.dataset.key;
        if(stats[key]>8){
          stats[key]--;
          SFX.play('click');
          renderStats();
          checkReady();
        }
      });
    });
  }
}

renderStats();

// Class selection
document.querySelectorAll('.class-card').forEach(c=>{c.addEventListener('click',()=>{
  SFX.play('click');document.querySelectorAll('.class-card').forEach(x=>x.classList.remove('selected'));
  c.classList.add('selected');selClass=c.dataset.cls;checkReady();})});

// Stat mode toggle
document.querySelectorAll('.stat-mode-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    SFX.play('click');
    document.querySelectorAll('.stat-mode-btn').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    statMode=btn.dataset.mode;
    if(statMode==='pointbuy'){
      stats={str:8,dex:8,con:8,int:8,wis:8,cha:8};
      rollDice={};
      statsAssigned=false;
    }else{
      // Roll all stats immediately
      SFX.play('dice');
      STAT_KEYS.forEach(k=>{
        const r=roll4d6Drop();
        stats[k]=r.total;
        rollDice[k]=r.rolls;
      });
      statsAssigned=true;
    }
    renderStats();
    checkReady();
  });
});

// Name input listener
document.getElementById('cc-name').addEventListener('input',()=>checkReady());

function checkReady(){
  const nameVal=document.getElementById('cc-name').value.trim();
  const ready=nameVal.length>0 && selClass && statsAssigned;
  document.getElementById('start-btn').disabled=!ready;
}

document.getElementById('start-btn').addEventListener('click',()=>{
  const name=document.getElementById('cc-name').value.trim();
  if(!name||!selClass||!statsAssigned)return;
  SFX.play('levelup');
  startGame(name,selClass,stats);
});
}

function startGame(name,cls,stats){
const cd=CLASS_DATA[cls];
G.player={name,class:cls,level:1,xp:0,xpNext:100,
hp:cd.hpBase+mod(stats.con),maxHp:cd.hpBase+mod(stats.con),
mana:cd.manaBase+mod(stats.int),maxMana:cd.manaBase+mod(stats.int),
stats:{...stats},ac:parseInt((cd.equipment.armor.match(/AC (\d+)/)||[0,10])[1]),
equipment:{weapon:cd.equipment.weapon,armor:cd.equipment.armor,shield:cd.equipment.shield},
weaponBonus:parseInt((cd.equipment.weapon.match(/\+(\d+)/)||[0,0])[1]),
skills:cd.skills,gold:15,inventory:['Health Potion','Health Potion','Ration']};
// starting quest
G.quests=[];addQuest();
G.phase='adventure';G.turn=0;G.events=0;
renderGame();
narrate(`<em>The flickering torchlight casts long shadows across the ancient map spread before you. You pull your cloak tighter against the cold night air, breath misting as you study the road ahead.</em>\n\n<strong>"${name},"</strong> you murmur to yourself, tracing a finger along the worn parchment. <strong>"This is where it begins."</strong>\n\nYou check your gear one final time -- ${cd.equipment.weapon} at your side, ${cd.equipment.armor} secured -- and step forward into the unknown.\n\n<em>And so your adventure begins. The world of Eldaria stretches before you -- a land of ancient ruins, dark forests, and forgotten dungeons. A lone ${cls.toLowerCase()} against the darkness. What legends will you forge?</em>`);
setTimeout(()=>presentAdventure(),100);
}

function addQuest(){
const t=pick(QUEST_TEMPLATES);
const m=pick(Q_MONSTERS),p=pick(Q_PLACES),it=pick(Q_ITEMS);
G.quests.push({name:t.name.replace('{monster}',m).replace('{place}',p).replace('{item}',it),
desc:t.desc.replace('{monster}',m).replace('{place}',p).replace('{item}',it),
type:t.type,progress:0,goal:d(3)+2,done:false});
}

// ========== MAIN GAME RENDERING ==========
function renderGame(){
app.innerHTML=`<div id="main-col">
<div id="narrative-box"></div>
<div id="choices"></div>
<div id="log-box"></div>
</div>
<div id="sidebar">
<div class="panel" id="p-char"></div>
<div class="panel" id="p-equip"></div>
<div class="panel" id="p-inv"></div>
<div class="panel" id="p-quests"></div>
</div>`;
updateSidebar();
}

function updateSidebar(){
if(G.phase==='create')return;
const p=G.player;
// character panel
document.getElementById('p-char').innerHTML=`<h3>${p.name} - Lvl ${p.level} ${p.class}</h3>
<div class="stat-row"><span>HP</span><span class="stat-val">${p.hp}/${p.maxHp}</span></div>
<div class="bar-outer"><div class="bar-inner hp-bar" style="width:${(p.hp/p.maxHp*100)}%"></div></div>
${p.maxMana>0?`<div class="stat-row"><span>Mana</span><span class="stat-val">${p.mana}/${p.maxMana}</span></div>
<div class="bar-outer"><div class="bar-inner mana-bar" style="width:${(p.mana/p.maxMana*100)}%"></div></div>`:''}
<div class="stat-row"><span>XP</span><span class="stat-val">${p.xp}/${p.xpNext}</span></div>
<div class="bar-outer"><div class="bar-inner xp-bar" style="width:${(p.xp/p.xpNext*100)}%"></div></div>
<div class="stat-row"><span>Gold</span><span style="color:#f1c40f">${p.gold} gp</span></div>
<div class="stat-row"><span>AC</span><span class="stat-val">${p.ac}</span></div>
<div style="margin-top:6px;border-top:1px solid rgba(255,255,255,.06);padding-top:4px">
${['str','dex','con','int','wis','cha'].map(k=>`<div class="stat-row"><span>${k.toUpperCase()}</span><span class="stat-val">${p.stats[k]} (${modStr(p.stats[k])})</span></div>`).join('')}
</div>`;
// equipment
document.getElementById('p-equip').innerHTML=`<h3>Equipment</h3>
<div class="equip-slot"><span>Weapon:</span><span class="item-name">${p.equipment.weapon}</span></div>
<div class="equip-slot"><span>Armor:</span><span class="item-name">${p.equipment.armor}</span></div>
<div class="equip-slot"><span>Off-hand:</span><span class="item-name">${p.equipment.shield}</span></div>`;
// inventory
document.getElementById('p-inv').innerHTML=`<h3>Inventory (${p.inventory.length})</h3>
${p.inventory.length?p.inventory.map(i=>`<div class="inv-item">&#8226; ${i}</div>`).join(''):'<div style="color:#666;font-size:11px">Empty</div>'}`;
// quests
document.getElementById('p-quests').innerHTML=`<h3>Quests</h3>
${G.quests.map(q=>`<div class="quest-item ${q.done?'quest-done':''}"><div class="q-name">${q.done?'&#10003;':'\u25CB'} ${q.name}</div><div class="q-desc">${q.desc} (${q.progress}/${q.goal})</div></div>`).join('')}`;
}

function narrate(html){
const nb=document.getElementById('narrative-box');
if(!nb)return;
nb.innerHTML+=`<div class="dm-text">${html.replace(/\n/g,'<br>')}</div>`;
nb.scrollTop=nb.scrollHeight;
}

function clearNarrative(){
const nb=document.getElementById('narrative-box');
if(nb)nb.innerHTML='';
}

function addLog(text){
const lb=document.getElementById('log-box');
if(!lb)return;
lb.innerHTML+=`<div class="log-entry">${text}</div>`;
lb.scrollTop=lb.scrollHeight;
}

function setChoices(choices){
const cb=document.getElementById('choices');
if(!cb)return;
cb.innerHTML='';
choices.forEach(ch=>{
const b=document.createElement('button');
b.textContent=ch.text;
b.addEventListener('click',()=>{SFX.play('click');ch.action();});
cb.appendChild(b);
});
}

// ========== ADVENTURE ENGINE ==========
function presentAdventure(){
G.turn++;G.events++;
updateSidebar();
if(G.player.hp<=0){gameOver();return;}
// check quest progress -- add new quest if all done
if(G.quests.every(q=>q.done)){addQuest();}
// check level up
checkLevelUp();
// random event selection
const roll=d(100);
let tier=Math.ceil(G.player.level/2);
if(roll<=25) encounterMonster(tier);
else if(roll<=40) townEvent();
else if(roll<=55) wildernessExploration();
else if(roll<=65) trapEncounter();
else if(roll<=75) treasureFind();
else if(roll<=82) mysteriousStranger();
else if(roll<=88) campEvent();
else if(roll<=93) shrineEvent();
else if(roll<=97) questEvent();
else stormEvent();
}

// ========== ENCOUNTERS ==========
function encounterMonster(tier){
tier=clamp(tier,1,5);
const possible=MONSTER_DATA.filter(m=>m.tier<=tier&&m.tier>=tier-1);
const template=pick(possible.length?possible:MONSTER_DATA.filter(m=>m.tier===1));
const scaling=1+((G.player.level-1)*0.15);
const monster={...template,hp:Math.round(template.hp*scaling),maxHp:Math.round(template.hp*scaling),
atk:Math.round(template.atk*scaling),xp:Math.round(template.xp*scaling),gold:Math.round(template.gold*scaling)};
G.encounter=monster;
const intros=[
`<em>The ground trembles beneath your feet. From the shadows emerges a fearsome <strong>${monster.name}</strong>!</em>\n\nYou draw your weapon and set your stance. The creature snarls, its eyes gleaming with malice.`,
`<em>A blood-curdling shriek pierces the air. A <strong>${monster.name}</strong> blocks your path, fangs bared and ready to strike!</em>\n\nYou grip your weapon tightly. "This one means business..."`,
`<em>You round a bend and freeze. There, amid the bones of previous travelers, a <strong>${monster.name}</strong> rises to face you. Its ${pick(['red','yellow','pale','glowing'])} eyes fix upon you.</em>\n\n"Steady," you whisper, steeling your nerves. "I can handle this."`
];
clearNarrative();
narrate(pick(intros));
narrate(`\n<span class="dm-label">&#9876; COMBAT: ${monster.name} (HP: ${monster.hp} | AC: ${monster.ac})</span>`);
addLog(`Combat started: ${monster.name} (HP:${monster.hp}, AC:${monster.ac})`);
combatTurn();
}

function combatTurn(){
const m=G.encounter;
if(!m||m.hp<=0){combatVictory();return;}
if(G.player.hp<=0){gameOver();return;}
updateSidebar();
const choices=[{text:'Attack (d20 + '+modStr(G.player.stats.str)+')',action:()=>playerAttack()},
{text:'Defend (brace for impact)',action:()=>playerDefend()}];
if(G.player.mana>=5){
const skill=G.player.skills[0];
choices.push({text:`${skill} (5 mana)`,action:()=>playerSkill(skill)});
}
if(G.player.inventory.includes('Health Potion')){
choices.push({text:'Use Health Potion',action:()=>usePotion()});
}
choices.push({text:'Flee (DC 12 Dex check)',action:()=>playerFlee()});
setChoices(choices);
}

function playerAttack(){
const r=d20();const atkMod=mod(G.player.stats.str)+G.player.weaponBonus;
const total=r+atkMod;
const m=G.encounter;
SFX.play('dice');
narrate(`<div class="roll-result">Attack Roll: <span class="die-val">${r}</span> + ${atkMod} = ${total} vs AC ${m.ac}</div>`);
if(total>=m.ac){
const dmg=d(8)+mod(G.player.stats.str)+G.player.weaponBonus;
m.hp=Math.max(0,m.hp-dmg);
SFX.play('hit');
narrate(`<span class="combat-hit">Hit! You strike the ${m.name} for ${dmg} damage!</span> (${m.name} HP: ${m.hp}/${m.maxHp})`);
addLog(`You hit ${m.name} for ${dmg} dmg. (${m.hp} HP left)`);
}else{
SFX.play('miss');
narrate(`<span class="combat-miss">Miss! Your attack fails to connect.</span>`);
addLog(`You missed ${m.name}.`);
}
if(m.hp<=0){combatVictory();return;}
monsterTurn();
}

function playerDefend(){
narrate(`<em>You raise your guard, bracing for the enemy's assault. (+4 AC this round)</em>`);
addLog('You defend. +4 AC this round.');
G.player.ac+=4;
monsterTurn();
G.player.ac-=4;
}

function playerSkill(skill){
G.player.mana-=5;
const r=d20();
let atkStat=G.player.class==='Mage'?'int':G.player.class==='Cleric'?'wis':'str';
const atkMod=mod(G.player.stats[atkStat])+G.player.level;
const total=r+atkMod;
const m=G.encounter;
SFX.play('dice');
narrate(`<div class="roll-result">${skill} Roll: <span class="die-val">${r}</span> + ${atkMod} = ${total} vs AC ${m.ac}</div>`);
if(total>=m.ac){
const dmg=d(10)+mod(G.player.stats[atkStat])+G.player.level*2;
m.hp=Math.max(0,m.hp-dmg);
SFX.play('hit');
narrate(`<span class="combat-hit">${skill} hits for ${dmg} damage!</span> (${m.name} HP: ${m.hp}/${m.maxHp})`);
addLog(`${skill}: ${dmg} dmg to ${m.name}.`);
if(skill==='Heal'||skill==='Bless'){
const healAmt=d(8)+mod(G.player.stats.wis);
G.player.hp=Math.min(G.player.maxHp,G.player.hp+healAmt);
narrate(`<span class="combat-heal">You also heal ${healAmt} HP!</span>`);
}
}else{
SFX.play('miss');narrate(`<span class="combat-miss">${skill} fizzles! No effect.</span>`);
}
if(m.hp<=0){combatVictory();return;}
monsterTurn();
}

function usePotion(){
const idx=G.player.inventory.indexOf('Health Potion');
if(idx>=0)G.player.inventory.splice(idx,1);
const heal=d(8)+4;
G.player.hp=Math.min(G.player.maxHp,G.player.hp+heal);
SFX.play('heal');
narrate(`<span class="combat-heal">You drink a Health Potion and recover ${heal} HP! (HP: ${G.player.hp}/${G.player.maxHp})</span>`);
addLog(`Used Health Potion: +${heal} HP.`);
monsterTurn();
}

function playerFlee(){
const r=d20();const total=r+mod(G.player.stats.dex);
SFX.play('dice');
narrate(`<div class="roll-result">Flee Check (DC 12): <span class="die-val">${r}</span> + ${mod(G.player.stats.dex)} = ${total}</div>`);
if(total>=12){
narrate(`<em>You disengage and slip away into the shadows!</em>`);
addLog('Fled successfully.');
G.encounter=null;
setTimeout(()=>presentAdventure(),50);
}else{
narrate(`<span class="combat-miss">You fail to escape! The ${G.encounter.name} blocks your path.</span>`);
addLog('Flee failed!');
monsterTurn();
}
}

function monsterTurn(){
const m=G.encounter;
if(!m||m.hp<=0)return;
const r=d20()+Math.floor(m.atk/2);
narrate(`\n<span class="dm-label">${m.name}'s Turn</span>`);
if(r>=G.player.ac){
const dmg=d(6)+Math.floor(m.atk/2);
G.player.hp=Math.max(0,G.player.hp-dmg);
SFX.play('hit');
narrate(`<span class="combat-hit">The ${m.name} strikes you for ${dmg} damage!</span> (Your HP: ${G.player.hp}/${G.player.maxHp})`);
addLog(`${m.name} hits you for ${dmg}.`);
}else{
SFX.play('miss');
narrate(`<span class="combat-miss">The ${m.name} attacks you but misses!</span>`);
}
if(G.player.hp<=0){gameOver();return;}
updateSidebar();
combatTurn();
}

function combatVictory(){
const m=G.encounter;
SFX.play('loot');
const xp=m.xp;const gold=m.gold+d(10);
G.player.xp+=xp;G.player.gold+=gold;
narrate(`\n<span class="loot-text">&#9876; VICTORY! The ${m.name} is defeated!</span>\n<span class="xp-text">+${xp} XP</span> | <span class="gold-text">+${gold} Gold</span>`);
addLog(`Defeated ${m.name}. +${xp} XP, +${gold} gold.`);
// quest progress
G.quests.filter(q=>!q.done&&(q.type==='kill'||q.type==='dungeon')).forEach(q=>{
q.progress++;if(q.progress>=q.goal){q.done=true;
const qxp=100*G.player.level;const qgold=50*G.player.level;
G.player.xp+=qxp;G.player.gold+=qgold;
SFX.play('levelup');
narrate(`<span class="loot-text">&#10003; QUEST COMPLETE: ${q.name}! +${qxp} XP, +${qgold} Gold</span>`);
addLog(`Quest done: ${q.name}. +${qxp} XP, +${qgold} gp.`);
addQuest();}
});
// random loot
if(d(100)<=40){
const loot=pick([...LOOT_WEAPONS.filter(l=>l.tier<=Math.ceil(G.player.level/2)+1),...LOOT_ARMOR.filter(l=>l.tier<=Math.ceil(G.player.level/2)+1)]);
if(loot){
G.player.inventory.push(loot.name);
narrate(`<span class="loot-text">You find: ${loot.name}!</span>`);
addLog(`Loot: ${loot.name}`);
}
}
G.encounter=null;
checkLevelUp();
updateSidebar();
setChoices([{text:'Continue your journey...',action:()=>{clearNarrative();presentAdventure();}}]);
}

// ========== NON-COMBAT EVENTS ==========
function townEvent(){
const town=pick(TOWN_NAMES);
clearNarrative();
const rumors=[
`"They say a dragon nests in the mountains to the north... its hoard would set a man up for life."`,
`"Travelers have gone missing on the eastern road. Something lurks in the shadows there."`,
`"An old wizard in the tower seeks adventurers. The pay is good, but the task... dangerous."`,
`"The dead don't rest easy in the old cemetery. Best avoid it after dark."`,
`"A merchant caravan was raided last week. Bandits grow bolder by the day."`
];
narrate(`<em>After hours of travel, the welcome sight of <strong>${town}</strong> appears on the horizon. Warm light spills from windows, and the smell of cooking fire reaches your nose.</em>\n\n"Finally, civilization," you sigh. "I could use a warm meal and a soft bed."\n\n<em>The townsfolk eye you with a mixture of hope and wariness. A grizzled innkeeper waves you over.</em>\n\n"Welcome, traveler. ${pick(rumors)}"`);
const choices=[
{text:`Rest at the Inn (10 gp) - Full heal`,action:()=>{
if(G.player.gold>=10){G.player.gold-=10;G.player.hp=G.player.maxHp;G.player.mana=G.player.maxMana;
SFX.play('heal');
narrate(`<em>You spend the night at the inn. The bed is surprisingly comfortable, and the ale flows freely. By morning, you are fully rested and refreshed.</em>`);
addLog(`Rested at ${town}. Fully healed.`);
updateSidebar();
setChoices([{text:'Continue your journey...',action:()=>{clearNarrative();presentAdventure();}}]);
}else{narrate(`<em>You pat your coin purse. Not enough gold...</em>`);}}},
{text:'Visit the Shop',action:()=>shopEvent(town)},
{text:'Hear Rumors (free)',action:()=>{
narrate(`\n<em>You spend an hour listening to the locals. Between mugs of ale, you piece together useful information.</em>\n\n${pick(rumors)}\n\n`);
const r=d20()+mod(G.player.stats.cha);
narrate(`<div class="roll-result">Charisma Check: <span class="die-val">${d20()}</span> + ${mod(G.player.stats.cha)} -- ${r>=12?'The locals warm to you!':'They seem guarded.'}</div>`);
if(r>=12){
const bonusGold=d(10)+5;G.player.gold+=bonusGold;
narrate(`<span class="gold-text">A grateful farmer slips you ${bonusGold} gold for your reputation.</span>`);
}
SFX.play('dice');updateSidebar();
setChoices([{text:'Continue your journey...',action:()=>{clearNarrative();presentAdventure();}}]);
}},
{text:'Leave town',action:()=>{clearNarrative();presentAdventure();}}
];
setChoices(choices);
}

function shopEvent(town){
clearNarrative();
narrate(`<em>The shopkeeper spreads their wares before you. "Take a look, friend. Fair prices for brave adventurers."</em>\n\n<strong>Your gold: ${G.player.gold} gp</strong>`);
const items=[
{name:'Health Potion',cost:10,desc:'Restores d8+4 HP'},
{name:'Greater Health Potion',cost:25,desc:'Restores 2d8+8 HP'},
{name:'Mana Potion',cost:15,desc:'Restores 10 Mana'},
{name:'Antidote',cost:8,desc:'Cures poison'},
{name:'Ration',cost:3,desc:'Trail food'},
{name:'Torch',cost:1,desc:'Lights the way'}
];
const choices=items.map(it=>({text:`Buy ${it.name} (${it.cost} gp)`,action:()=>{
if(G.player.gold>=it.cost){G.player.gold-=it.cost;G.player.inventory.push(it.name);
SFX.play('loot');narrate(`<span class="loot-text">Purchased: ${it.name}!</span> (Gold: ${G.player.gold} gp)`);updateSidebar();}
else{narrate(`<em>Not enough gold for ${it.name}.</em>`);}
}}));
// sell equipment from inventory
if(G.player.inventory.length>0){
choices.push({text:'Sell an item (half value)',action:()=>{
const item=G.player.inventory[0];
const val=Math.max(1,d(6)+2);
G.player.inventory.shift();G.player.gold+=val;
SFX.play('loot');narrate(`<span class="gold-text">Sold ${item} for ${val} gold.</span>`);updateSidebar();
}});
}
choices.push({text:'Leave shop',action:()=>{clearNarrative();presentAdventure();}});
setChoices(choices);
}

function wildernessExploration(){
clearNarrative();
const desc=pick(WILDERNESS_DESCS);
const events=[
()=>{// Fork in the road
narrate(`<em>You travel through ${desc}. The path splits before you -- one trail leads through a dark hollow, the other follows a ridge with a distant view.</em>\n\nYou study both paths. The hollow looks faster, but you don't like the feel of it.`);
setChoices([
{text:'Take the dark hollow (risky)',action:()=>{
const r=d20()+mod(G.player.stats.wis);
SFX.play('dice');
narrate(`<div class="roll-result">Wisdom Check (DC 13): <span class="die-val">${r-mod(G.player.stats.wis)}</span> + ${mod(G.player.stats.wis)} = ${r}</div>`);
if(r>=13){
const gold=d(20)+10;G.player.gold+=gold;
narrate(`<em>You navigate the hollow safely and discover an old stash hidden in a tree trunk!</em>\n<span class="gold-text">Found ${gold} gold!</span>`);
SFX.play('loot');
}else{
const dmg=d(6)+2;G.player.hp=Math.max(1,G.player.hp-dmg);
narrate(`<em>Poisonous thorns scratch your arms in the darkness. You take ${dmg} damage!</em>`);
SFX.play('hit');
}
updateSidebar();
setChoices([{text:'Press onward...',action:()=>{clearNarrative();presentAdventure();}}]);
}},
{text:'Take the ridge (safe)',action:()=>{
narrate(`<em>The ridge path offers breathtaking views of the valley below. You travel safely, arriving at the next landmark in good spirits.</em>`);
updateSidebar();
setChoices([{text:'Press onward...',action:()=>{clearNarrative();presentAdventure();}}]);
}}
]);
},
()=>{// Abandoned campsite
narrate(`<em>You stumble upon an abandoned campsite in ${desc}. The fire pit is cold, but supplies are scattered about as if the previous occupants left in a hurry.</em>\n\n"Looks like they left in a rush," you observe, scanning the area for danger.`);
setChoices([
{text:'Search the campsite',action:()=>{
const r=d20()+mod(G.player.stats.int);
SFX.play('dice');
narrate(`<div class="roll-result">Investigation Check (DC 11): <span class="die-val">${r-mod(G.player.stats.int)}</span> + ${mod(G.player.stats.int)} = ${r}</div>`);
if(r>=11){
G.player.inventory.push('Health Potion');
const gold=d(8)+3;G.player.gold+=gold;
SFX.play('loot');narrate(`<span class="loot-text">You find a Health Potion and ${gold} gold hidden under a bedroll!</span>`);
}else{narrate(`<em>You search thoroughly but find nothing of value. Whatever was here, someone else found it first.</em>`);}
updateSidebar();
setChoices([{text:'Continue onward...',action:()=>{clearNarrative();presentAdventure();}}]);
}},
{text:'Move on (safer)',action:()=>{clearNarrative();presentAdventure();}}
]);
},
()=>{// River crossing
narrate(`<em>A swollen river blocks your path through ${desc}. The current is strong, and the water looks dangerously deep. A fallen log offers a precarious bridge.</em>\n\nYou eye the log warily. "I don't trust that thing."`);
setChoices([
{text:'Cross the log (Dex check DC 12)',action:()=>{
const r=d20()+mod(G.player.stats.dex);
SFX.play('dice');
narrate(`<div class="roll-result">Dexterity Check (DC 12): <span class="die-val">${r-mod(G.player.stats.dex)}</span> + ${mod(G.player.stats.dex)} = ${r}</div>`);
if(r>=12){
narrate(`<em>You balance carefully across the log. On the far bank, you spot something glinting in the mud.</em>`);
const gold=d(12)+5;G.player.gold+=gold;
SFX.play('loot');narrate(`<span class="gold-text">Found ${gold} gold coins washed downstream!</span>`);
}else{
const dmg=d(4)+1;G.player.hp=Math.max(1,G.player.hp-dmg);
narrate(`<em>You slip halfway across and plunge into the icy water! You manage to swim to shore, but you're bruised and cold. ${dmg} damage taken.</em>`);
SFX.play('hit');
}
updateSidebar();
setChoices([{text:'Continue the journey...',action:()=>{clearNarrative();presentAdventure();}}]);
}},
{text:'Find another crossing (slow but safe)',action:()=>{
narrate(`<em>You spend extra time searching and find a shallow ford downstream. Safe, but the detour costs time.</em>`);
setChoices([{text:'Continue...',action:()=>{clearNarrative();presentAdventure();}}]);
}}
]);
}
];
pick(events)();
}

function trapEncounter(){
clearNarrative();
const traps=[
{name:'Pit Trap',desc:'The ground gives way beneath your feet!',stat:'dex',dc:13,dmg:()=>d(8)+2},
{name:'Poison Dart Trap',desc:'Click! A volley of darts shoots from the wall!',stat:'dex',dc:14,dmg:()=>d(6)+3},
{name:'Arcane Rune',desc:'A glowing rune flares to life as you step near it!',stat:'int',dc:12,dmg:()=>d(10)+2},
{name:'Tripwire',desc:'A thin wire catches your ankle -- you hear a mechanism click!',stat:'dex',dc:11,dmg:()=>d(6)+1},
{name:'Collapsing Ceiling',desc:'Cracks spider across the ceiling above you!',stat:'str',dc:14,dmg:()=>d(10)+4}
];
const trap=pick(traps);
narrate(`<em>As you proceed cautiously, your instincts scream a warning!</em>\n\n<strong>"${trap.name}!"</strong>\n\n<em>${trap.desc}</em>`);
narrate(`\n<span class="dm-label">Roll a ${trap.stat.toUpperCase()} saving throw! (DC ${trap.dc})</span>`);
setChoices([{text:`Roll ${trap.stat.toUpperCase()} Save (DC ${trap.dc})`,action:()=>{
const r=d20();const total=r+mod(G.player.stats[trap.stat]);
SFX.play('dice');
narrate(`<div class="roll-result">${trap.stat.toUpperCase()} Save: <span class="die-val">${r}</span> + ${mod(G.player.stats[trap.stat])} = ${total} vs DC ${trap.dc}</div>`);
if(total>=trap.dc){
narrate(`<em>You react just in time! The ${trap.name.toLowerCase()} narrowly misses you.</em>`);
addLog(`Avoided ${trap.name}!`);
const xp=15+G.player.level*5;G.player.xp+=xp;
narrate(`<span class="xp-text">+${xp} XP for quick reflexes!</span>`);
}else{
const dmg=trap.dmg();
G.player.hp=Math.max(1,G.player.hp-dmg);
SFX.play('hit');
narrate(`<span class="combat-hit">The ${trap.name.toLowerCase()} catches you! You take ${dmg} damage!</span>`);
addLog(`Hit by ${trap.name}: -${dmg} HP.`);
}
updateSidebar();
setChoices([{text:'Proceed carefully...',action:()=>{clearNarrative();presentAdventure();}}]);
}}]);
}

function treasureFind(){
clearNarrative();
const scenarios=[
`<em>A glint of metal catches your eye -- half-buried in the earth is an old iron chest! The lock is rusted but still holds.</em>`,
`<em>Behind a waterfall, you discover a hidden alcove. Inside, a dusty leather sack sits atop a flat stone.</em>`,
`<em>The skeleton of a long-dead adventurer slumps against a wall, their pack still intact beside them. Perhaps their loss can be your gain...</em>`
];
narrate(pick(scenarios));
setChoices([
{text:'Open it! (Dex check DC 10 to pick lock)',action:()=>{
const r=d20()+mod(G.player.stats.dex);
SFX.play('dice');
narrate(`<div class="roll-result">Dexterity Check (DC 10): <span class="die-val">${r-mod(G.player.stats.dex)}</span> + ${mod(G.player.stats.dex)} = ${r}</div>`);
if(r>=10){
const gold=d(20)+10+G.player.level*5;G.player.gold+=gold;
SFX.play('loot');
narrate(`<span class="loot-text">The lock clicks open! Inside you find ${gold} gold!</span>`);
if(d(100)<=50){
const loot=pick([...LOOT_WEAPONS,...LOOT_ARMOR].filter(l=>l.tier<=Math.ceil(G.player.level/2)+1));
if(loot){G.player.inventory.push(loot.name);narrate(`<span class="loot-text">You also find: ${loot.name}!</span>`);}
}
if(d(100)<=30){G.player.inventory.push('Health Potion');narrate(`<span class="loot-text">And a Health Potion!</span>`);}
}else{
narrate(`<em>The lock resists your attempts. In frustration, you force it open but a small blade springs out!</em>`);
const dmg=d(4);G.player.hp=Math.max(1,G.player.hp-dmg);SFX.play('hit');
narrate(`<span class="combat-hit">Trapped! ${dmg} damage from the hidden blade.</span>`);
const gold=d(10)+5;G.player.gold+=gold;narrate(`<span class="gold-text">At least you find ${gold} gold inside.</span>`);
}
addLog('Found treasure!');updateSidebar();
setChoices([{text:'Continue your adventure...',action:()=>{clearNarrative();presentAdventure();}}]);
}},
{text:'Leave it (might be trapped)',action:()=>{
narrate(`<em>Wisdom sometimes means knowing when to walk away. You leave the treasure and continue onward.</em>`);
setChoices([{text:'Continue...',action:()=>{clearNarrative();presentAdventure();}}]);
}}
]);
}

function mysteriousStranger(){
clearNarrative();
const strangers=[
{desc:`<em>A cloaked figure steps from the treeline, hands raised in peace. Their face is hidden, but their voice is warm and measured.</em>\n\n"I mean you no harm, traveler. I am but a wanderer with a proposition..."`,
choices:[
{text:'Hear them out',action:()=>{
const r=d20()+mod(G.player.stats.wis);
SFX.play('dice');
narrate(`<div class="roll-result">Wisdom Check (DC 10): <span class="die-val">${r-mod(G.player.stats.wis)}</span> + ${mod(G.player.stats.wis)} = ${r}</div>`);
if(r>=10){
narrate(`<em>"I can see you are true of heart. Take this -- you will need it more than I."</em>`);
G.player.inventory.push('Health Potion');G.player.inventory.push('Health Potion');
const gold=d(15)+10;G.player.gold+=gold;
SFX.play('loot');narrate(`<span class="loot-text">The stranger gives you 2 Health Potions and ${gold} gold!</span>`);
}else{
narrate(`<em>Something feels off. You accept their offer, but the "potion" they give you tastes strange...</em>`);
const dmg=d(4);G.player.hp=Math.max(1,G.player.hp-dmg);SFX.play('hit');
narrate(`<span class="combat-hit">It was poison! -${dmg} HP. The stranger vanishes into the shadows.</span>`);
}
updateSidebar();setChoices([{text:'Continue...',action:()=>{clearNarrative();presentAdventure();}}]);
}},
{text:'Refuse and walk away',action:()=>{narrate(`<em>You politely decline and continue on your way. The stranger watches you go in silence.</em>`);
setChoices([{text:'Continue...',action:()=>{clearNarrative();presentAdventure();}}]);}}
]},
{desc:`<em>An old woman sits beside the road, a crystal ball before her on a faded cloth. She beckons with a gnarled finger.</em>\n\n"Come, let me read your fortune, brave one. For a small offering of gold, I can reveal what lies ahead..."`,
choices:[
{text:'Pay 15 gold for a reading',action:()=>{
if(G.player.gold>=15){G.player.gold-=15;
const fortunes=['Your next battle will be fierce, but victory is assured if you stand firm.','A great treasure awaits in the darkness ahead.','Beware the one who smiles -- they are not what they seem.','The stars favor you. Fortune smiles upon your quest.'];
narrate(`<em>The crystal ball swirls with mist. "${pick(fortunes)}"</em>`);
// buff: small stat boost for narrative flavor, plus a bonus item
G.player.inventory.push('Potion of Fortune');
SFX.play('loot');narrate(`<span class="loot-text">She slips you a Potion of Fortune!</span>`);
}else{narrate(`<em>You lack the coin. The old woman shrugs and returns to her crystal ball.</em>`);}
updateSidebar();setChoices([{text:'Continue...',action:()=>{clearNarrative();presentAdventure();}}]);
}},
{text:'Decline politely',action:()=>{narrate(`<em>"Your loss, dear. The road is long and full of surprises..."</em>`);
setChoices([{text:'Continue...',action:()=>{clearNarrative();presentAdventure();}}]);}}
]}
];
const s=pick(strangers);
narrate(s.desc);
setChoices(s.choices);
}

function campEvent(){
clearNarrative();
narrate(`<em>Night falls and you make camp beneath the stars. The fire crackles as the heavens wheel overhead. You settle in, keeping your weapon close.</em>\n\nThe warmth of the campfire is a welcome comfort after the day's hardships.`);
setChoices([
{text:'Rest and recover',action:()=>{
const heal=d(6)+mod(G.player.stats.con)+2;
G.player.hp=Math.min(G.player.maxHp,G.player.hp+heal);
G.player.mana=Math.min(G.player.maxMana,G.player.mana+Math.floor(G.player.maxMana/3));
SFX.play('heal');
narrate(`<em>A peaceful night's rest restores your strength.</em>\n<span class="combat-heal">You recover ${heal} HP.</span>`);
updateSidebar();
setChoices([{text:'Break camp and continue...',action:()=>{clearNarrative();presentAdventure();}}]);
}},
{text:'Reflect on your journey (gain XP)',action:()=>{
narrate(`<em>You sit by the fire, reflecting on the battles fought and the lessons learned. The quiet solitude sharpens your focus. Every scar tells a story, and every story makes you stronger.</em>`);
const xp=10+G.player.level*3;G.player.xp+=xp;
narrate(`<span class="xp-text">+${xp} XP from quiet reflection.</span>`);
updateSidebar();
setChoices([{text:'Break camp...',action:()=>{clearNarrative();presentAdventure();}}]);
}},
{text:'Keep watch (Perception check)',action:()=>{
const r=d20()+mod(G.player.stats.wis);
SFX.play('dice');
narrate(`<div class="roll-result">Perception Check (DC 13): <span class="die-val">${r-mod(G.player.stats.wis)}</span> + ${mod(G.player.stats.wis)} = ${r}</div>`);
if(r>=13){
narrate(`<em>Your vigilance pays off! You spot movement in the treeline -- bandits planning an ambush. You prepare a counter-ambush, driving them off before they can strike.</em>`);
const gold=d(20)+15;G.player.gold+=gold;G.player.xp+=30;
SFX.play('loot');narrate(`<span class="loot-text">The bandits flee, dropping ${gold} gold!</span>\n<span class="xp-text">+30 XP</span>`);
}else{
narrate(`<em>The night passes uneventfully. You nod off briefly but nothing happens -- this time.</em>`);
G.player.hp=Math.min(G.player.maxHp,G.player.hp+d(4));
}
updateSidebar();
setChoices([{text:'Break camp...',action:()=>{clearNarrative();presentAdventure();}}]);
}}
]);
}

function shrineEvent(){
clearNarrative();
const shrines=[
{name:'Shrine of Valor',stat:'str',desc:'A weathered stone shrine to an ancient war god. A sword is carved into the altar.'},
{name:'Shrine of Shadows',stat:'dex',desc:'A dark alcove with a shrine to the god of thieves. A silver coin gleams on the altar.'},
{name:'Shrine of Wisdom',stat:'wis',desc:'A serene pool surrounds a moss-covered shrine. The air hums with quiet power.'},
{name:'Shrine of Knowledge',stat:'int',desc:'An ancient library shrine, books turned to stone. Runes glow faintly on the pedestal.'}
];
const shrine=pick(shrines);
narrate(`<em>${shrine.desc}</em>\n\nYou study the shrine carefully. "These old shrines sometimes grant blessings to the worthy... but they can also curse the unworthy."`);
setChoices([
{text:`Pray at the ${shrine.name}`,action:()=>{
const r=d20();
SFX.play('dice');
narrate(`<div class="roll-result">Divine Favor: <span class="die-val">${r}</span></div>`);
if(r>=10){
G.player.stats[shrine.stat]+=1;
SFX.play('levelup');
narrate(`<span class="loot-text">The shrine glows with warm light! Your ${shrine.stat.toUpperCase()} permanently increases by 1!</span> (Now: ${G.player.stats[shrine.stat]})`);
G.player.hp=G.player.maxHp;G.player.mana=G.player.maxMana;
narrate(`<span class="combat-heal">You feel completely restored!</span>`);
}else{
const dmg=d(6)+2;G.player.hp=Math.max(1,G.player.hp-dmg);
SFX.play('hit');
narrate(`<span class="combat-hit">The shrine pulses with dark energy! You take ${dmg} damage as the old magic lashes out.</span>`);
}
updateSidebar();
setChoices([{text:'Continue your journey...',action:()=>{clearNarrative();presentAdventure();}}]);
}},
{text:'Pass by respectfully',action:()=>{
narrate(`<em>You bow your head in respect and continue on your way. Some powers are best left undisturbed.</em>`);
setChoices([{text:'Continue...',action:()=>{clearNarrative();presentAdventure();}}]);
}}
]);
}

function questEvent(){
clearNarrative();
const activeQuest=G.quests.find(q=>!q.done);
if(activeQuest){
activeQuest.progress++;
narrate(`<em>Your travels bring you closer to completing your quest: <strong>${activeQuest.name}</strong>.</em>\n\nA weathered signpost points the way. You study it carefully. "Making progress. ${activeQuest.goal-activeQuest.progress} more steps to go."\n\n<span class="xp-text">Quest progress: ${activeQuest.progress}/${activeQuest.goal}</span>`);
if(activeQuest.progress>=activeQuest.goal){
activeQuest.done=true;
const qxp=100*G.player.level;const qgold=50*G.player.level;
G.player.xp+=qxp;G.player.gold+=qgold;
SFX.play('levelup');
narrate(`\n<span class="loot-text">&#10003; QUEST COMPLETE: ${activeQuest.name}! +${qxp} XP, +${qgold} Gold</span>`);
addLog(`Quest done: ${activeQuest.name}.`);
addQuest();
}
}else{
narrate(`<em>A notice board at a crossroads catches your eye. New quests are posted...</em>`);
addQuest();
narrate(`<span class="loot-text">New quest: ${G.quests[G.quests.length-1].name}</span>`);
}
updateSidebar();
setChoices([{text:'Continue your adventure...',action:()=>{clearNarrative();presentAdventure();}}]);
}

function stormEvent(){
clearNarrative();
narrate(`<em>Dark clouds roll in with unnatural speed. Thunder cracks across the sky and rain lashes down upon you. Lightning illuminates the landscape in stark white flashes.</em>\n\n"Need to find shelter!" you shout against the howling wind.`);
setChoices([
{text:'Seek shelter in a cave',action:()=>{
const r=d20()+mod(G.player.stats.wis);
SFX.play('dice');
narrate(`<div class="roll-result">Survival Check (DC 11): <span class="die-val">${r-mod(G.player.stats.wis)}</span> + ${mod(G.player.stats.wis)} = ${r}</div>`);
if(r>=11){
narrate(`<em>You find a dry cave and wait out the storm. Inside, ancient cave paintings depict a great battle...</em>`);
G.player.xp+=20;narrate(`<span class="xp-text">+20 XP from studying the paintings.</span>`);
if(d(100)<=30){
const gold=d(15)+5;G.player.gold+=gold;
SFX.play('loot');narrate(`<span class="gold-text">You find ${gold} gold tucked in a crevice!</span>`);
}
}else{
narrate(`<em>The cave you find is already occupied! A startled bear charges at you before you can react!</em>`);
const dmg=d(6)+3;G.player.hp=Math.max(1,G.player.hp-dmg);
SFX.play('hit');narrate(`<span class="combat-hit">The bear mauls you before fleeing! -${dmg} HP</span>`);
}
updateSidebar();
setChoices([{text:'Continue when the storm passes...',action:()=>{clearNarrative();presentAdventure();}}]);
}},
{text:'Push through the storm (Con check DC 13)',action:()=>{
const r=d20()+mod(G.player.stats.con);
SFX.play('dice');
narrate(`<div class="roll-result">Constitution Check (DC 13): <span class="die-val">${r-mod(G.player.stats.con)}</span> + ${mod(G.player.stats.con)} = ${r}</div>`);
if(r>=13){
narrate(`<em>Gritting your teeth against the elements, you push through. The storm breaks and golden sunlight bathes the land. Your resolve has been tested and found worthy.</em>`);
G.player.xp+=40;narrate(`<span class="xp-text">+40 XP for enduring the storm!</span>`);
}else{
const dmg=d(4)+2;G.player.hp=Math.max(1,G.player.hp-dmg);
narrate(`<span class="combat-hit">The storm batters you! You lose ${dmg} HP.</span>`);
SFX.play('hit');
}
updateSidebar();
setChoices([{text:'Continue...',action:()=>{clearNarrative();presentAdventure();}}]);
}}
]);
}

// ========== LEVELING ==========
function checkLevelUp(){
while(G.player.xp>=G.player.xpNext){
G.player.xp-=G.player.xpNext;
G.player.level++;
G.player.xpNext=Math.floor(G.player.xpNext*1.5);
const hpGain=d(CLASS_DATA[G.player.class].hpBase)+mod(G.player.stats.con);
G.player.maxHp+=hpGain;G.player.hp=G.player.maxHp;
G.player.maxMana+=Math.floor(CLASS_DATA[G.player.class].manaBase/3);G.player.mana=G.player.maxMana;
// boost a random stat
const statKeys=['str','dex','con','int','wis','cha'];
const boostStat=pick(statKeys);
G.player.stats[boostStat]+=1;
SFX.play('levelup');
narrate(`\n<span class="loot-text" style="font-size:19px">&#9733; LEVEL UP! You are now Level ${G.player.level}! &#9733;</span>\n<span class="combat-heal">+${hpGain} Max HP | ${boostStat.toUpperCase()} +1 | Full heal!</span>`);
addLog(`LEVEL UP to ${G.player.level}! +${hpGain} Max HP, ${boostStat.toUpperCase()} +1.`);
updateSidebar();
}
}

// ========== GAME OVER ==========
function gameOver(){
SFX.play('death');
clearNarrative();
narrate(`<em>The world grows dark. Your wounds are too grievous, your strength spent. As consciousness fades, you collapse to the cold ground.</em>\n\n"Not... like this..." you whisper, clutching your weapon one last time.\n\n<em>The light fades. Your adventure ends here, but the tales of <strong>${G.player.name}</strong> the ${G.player.class} will be told for generations.</em>\n\n<strong style="color:#e74c3c;font-size:22px">&#9760; GAME OVER &#9760;</strong>\n\nYou reached <strong>Level ${G.player.level}</strong> with <strong>${G.player.gold} gold</strong>.\nQuests completed: <strong>${G.quests.filter(q=>q.done).length}</strong>\nEncounters survived: <strong>${G.events}</strong>.`);
setChoices([{text:'Start a New Adventure',action:()=>{G={phase:'create',player:null,quests:[],turn:0,encounter:null,location:'wilderness',combatLog:[],events:0};renderCreate();}}]);
}

// ========== EQUIP FROM INVENTORY ==========
// Simple auto-equip: on finding weapons/armor, check if better
function tryAutoEquip(){
const p=G.player;
p.inventory.forEach((item,idx)=>{
const wMatch=item.match(/\+(\d+)\)$/);
const aMatch=item.match(/AC (\d+)\)/);
if(wMatch){
const bonus=parseInt(wMatch[1]);
if(bonus>p.weaponBonus){
const old=p.equipment.weapon;
p.equipment.weapon=item;p.weaponBonus=bonus;
p.inventory[idx]=old;
narrate(`<span class="loot-text">Equipped ${item}! (replaced ${old})</span>`);
}
}else if(aMatch){
const ac=parseInt(aMatch[1]);
if(ac>p.ac){
const old=p.equipment.armor;
p.equipment.armor=item;p.ac=ac;
p.inventory[idx]=old;
narrate(`<span class="loot-text">Equipped ${item}! (replaced ${old})</span>`);
}
}
});
// clean up inventory - remove equipped items that were swapped
p.inventory=p.inventory.filter(i=>i!==p.equipment.weapon&&i!==p.equipment.armor);
}

// Override loot narration to auto-equip
const origNarrate=narrate;
const origCombatVictory=combatVictory;

// Patch: after adding loot to inventory, try auto-equip
const _origPresentAdv=presentAdventure;

// ========== INIT ==========
renderCreate();
</script>
</body>
</html>

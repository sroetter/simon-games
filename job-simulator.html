<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mall Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 36px;
        }

        .home-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
            font-weight: bold;
        }

        .home-button:hover {
            background: #667eea;
            color: white;
        }

        /* Job Selection Screen */
        .job-selection {
            text-align: center;
        }

        .job-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .job-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .job-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .job-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .job-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .job-description {
            font-size: 14px;
            color: #666;
        }

        /* Game Screen */
        .game-screen {
            display: none;
        }

        .stats-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .customer-area {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
        }

        .inventory-area {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .customer {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .customer-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .customer-avatar {
            font-size: 50px;
        }

        .customer-details h3 {
            color: #333;
            margin-bottom: 5px;
        }

        .customer-request {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-style: italic;
        }

        .customer-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-serve {
            background: #28a745;
            color: white;
        }

        .btn-serve:hover {
            background: #218838;
        }

        .btn-serve:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-ignore {
            background: #dc3545;
            color: white;
        }

        .btn-ignore:hover {
            background: #c82333;
        }

        .inventory-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .inventory-item.unlocked {
            animation: unlockGlow 1s ease-out;
        }

        @keyframes unlockGlow {
            0% {
                border-color: #ffd700;
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            }
            100% {
                border-color: #e0e0e0;
                box-shadow: none;
            }
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-name {
            font-weight: bold;
            color: #333;
        }

        .item-stock {
            color: #666;
            font-size: 14px;
        }

        .item-actions {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .btn-small:hover {
            background: #5568d3;
        }

        .buy-price {
            font-size: 12px;
            color: #28a745;
        }

        .no-customers {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 18px;
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            animation: fadeInOut 2s ease-out;
            z-index: 1000;
        }

        .message.success {
            background: #28a745;
            color: white;
        }

        .message.error {
            background: #dc3545;
            color: white;
        }

        .message.info {
            background: #17a2b8;
            color: white;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upgrades-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .upgrade-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upgrade-info {
            flex: 1;
        }

        .upgrade-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .upgrade-description {
            font-size: 12px;
            color: #666;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="home-button">üè† Home</a>

    <div class="game-container">
        <h1>üè¨ Mall Simulator</h1>

        <!-- Job Selection Screen -->
        <div id="jobSelection" class="job-selection">
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Open your own mall! Pick a store or run the whole thing!</p>
            <div class="job-grid">
                <div class="job-card" onclick="startJob('all')" style="border:3px solid #ffd700;background:linear-gradient(135deg,#fff9c4,#ffe082)">
                    <div class="job-icon">üè¨</div>
                    <div class="job-title">Full Mall!</div>
                    <div class="job-description">Run ALL stores at once! Food court, convenience store, grocery, post office, and farmers market!</div>
                </div>
                <div class="job-card" onclick="startJob('chef')">
                    <div class="job-icon">üçî</div>
                    <div class="job-title">Food Court</div>
                    <div class="job-description">Run the mall's food court! Burgers, pizza, sushi, and more for hungry shoppers</div>
                </div>
                <div class="job-card" onclick="startJob('shop')">
                    <div class="job-icon">üè™</div>
                    <div class="job-title">Convenience Store</div>
                    <div class="job-description">Snacks, drinks, candy, and ice cream - keep the shelves stocked!</div>
                </div>
                <div class="job-card" onclick="startJob('supermarket')">
                    <div class="job-icon">üõí</div>
                    <div class="job-title">Grocery Store</div>
                    <div class="job-description">Fresh bread, milk, eggs, fruit, cheese, and meat for families</div>
                </div>
                <div class="job-card" onclick="startJob('mailman')">
                    <div class="job-icon">üì¶</div>
                    <div class="job-title">Post Office</div>
                    <div class="job-description">Letters, packages, and express mail - keep the deliveries flowing!</div>
                </div>
                <div class="job-card" onclick="startJob('farmer')">
                    <div class="job-icon">üåΩ</div>
                    <div class="job-title">Farmers Market</div>
                    <div class="job-description">Fresh corn, tomatoes, wheat, and strawberries straight from the farm!</div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="game-screen">
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-label">üí∞ Money</div>
                    <div class="stat-value">$<span id="money">100</span></div>
                </div>
                <div class="stat">
                    <div class="stat-label">üòä Reputation</div>
                    <div class="stat-value"><span id="reputation">50</span>%</div>
                </div>
                <div class="stat">
                    <div class="stat-label">üë• Served</div>
                    <div class="stat-value"><span id="customersServed">0</span></div>
                </div>
                <div class="stat">
                    <div class="stat-label">üìä Level</div>
                    <div class="stat-value"><span id="level">1</span></div>
                </div>
                <div class="stat">
                    <div class="stat-label">üî• Combo</div>
                    <div class="stat-value">x<span id="combo">0</span></div>
                </div>
                <div class="stat">
                    <div class="stat-label">üìÖ Day</div>
                    <div class="stat-value"><span id="dayCount">1</span></div>
                </div>
            </div>
            <div style="background:rgba(0,0,0,.05);border-radius:8px;padding:8px 15px;margin-bottom:15px;display:flex;align-items:center;gap:10px">
                <span style="font-size:13px;color:#666">XP:</span>
                <div style="flex:1;height:14px;background:#ddd;border-radius:7px;overflow:hidden">
                    <div id="xp-bar" style="height:100%;background:linear-gradient(90deg,#667eea,#764ba2);border-radius:7px;transition:width .3s;width:0%"></div>
                </div>
                <span id="xp-text" style="font-size:12px;color:#666">0/10</span>
            </div>
            <div id="event-banner" style="display:none;background:linear-gradient(135deg,#ffd700,#ff8c00);color:#333;padding:12px 20px;border-radius:8px;margin-bottom:15px;font-weight:bold;text-align:center;animation:slideIn .3s ease-out"></div>

            <div class="main-content">
                <div class="customer-area">
                    <div class="section-title">üë• Customers</div>
                    <div id="customerList">
                        <div class="no-customers">Waiting for customers...</div>
                    </div>
                </div>

                <div class="inventory-area">
                    <div class="section-title">üì¶ Inventory</div>
                    <div id="inventoryList"></div>
                </div>
            </div>

            <div class="upgrades-section">
                <div class="section-title">‚≠ê Upgrades</div>
                <div id="upgradesList"></div>
            </div>
        </div>
    </div>

    <script>
        // Audio
        const AudioCtor = window.AudioContext || window.webkitAudioContext;
        const audio = new AudioCtor();
        function tone(type,freq,freqEnd,dur,vol){
            if(audio.state==='suspended')audio.resume();
            const o=audio.createOscillator(),g=audio.createGain();
            o.connect(g);g.connect(audio.destination);
            const t=audio.currentTime; o.type=type;
            o.frequency.setValueAtTime(freq,t);
            if(freqEnd!==null)o.frequency.exponentialRampToValueAtTime(Math.max(freqEnd,1),t+dur);
            g.gain.setValueAtTime(vol,t);g.gain.exponentialRampToValueAtTime(.001,t+dur);
            o.start(t);o.stop(t+dur);
        }
        function sfx(name){
            if(audio.state==='suspended')audio.resume();
            switch(name){
                case 'sell': tone('sine',500,800,.1,.15); tone('sine',800,1200,.1,.12); break;
                case 'buy': tone('triangle',400,200,.1,.1); break;
                case 'levelup': {
                    const t=audio.currentTime;
                    [400,500,600,800].forEach((f,i)=>{
                        const o=audio.createOscillator(),g=audio.createGain();
                        o.connect(g);g.connect(audio.destination);o.type='sine';
                        o.frequency.setValueAtTime(f,t+i*.1);
                        g.gain.setValueAtTime(.15,t+i*.1);g.gain.exponentialRampToValueAtTime(.001,t+i*.1+.2);
                        o.start(t+i*.1);o.stop(t+i*.1+.2);
                    }); break;
                }
                case 'fail': tone('sawtooth',300,100,.2,.15); break;
                case 'combo': tone('sine',600,1400,.15,.2); break;
                case 'event': tone('square',800,400,.15,.12); tone('square',600,900,.15,.12); break;
                case 'upgrade': tone('sine',400,1000,.2,.15); break;
                case 'coin': tone('sine',1200,800,.06,.1); break;
            }
        }

        // Game State
        let gameState = {
            money: 100,
            reputation: 50,
            customersServed: 0,
            level: 1,
            xp: 0,
            xpNeeded: 10,
            currentJob: null,
            inventory: {},
            unlockedProducts: [],
            customers: [],
            customerIdCounter: 0,
            combo: 0,
            comboTimer: null,
            totalEarned: 0,
            dayCount: 1,
            upgrades: {
                betterEquipment: false,
                marketing: false,
                automation: false,
                bigStorage: false,
                vipLounge: false,
                speedService: false
            }
        };

        // Job Configurations
        const jobs = {
            chef: {
                name: "Food Court",
                icon: "üçî",
                products: {
                    burger: { name: "Burger", icon: "üçî", buyPrice: 4, sellPrice: 12, stock: 8, unlockLevel: 1 },
                    pizza: { name: "Pizza", icon: "üçï", buyPrice: 6, sellPrice: 15, stock: 6, unlockLevel: 1 },
                    pasta: { name: "Pasta", icon: "üçù", buyPrice: 5, sellPrice: 13, stock: 7, unlockLevel: 3 },
                    salad: { name: "Salad", icon: "ü•ó", buyPrice: 3, sellPrice: 9, stock: 10, unlockLevel: 2 },
                    steak: { name: "Steak", icon: "ü•©", buyPrice: 10, sellPrice: 25, stock: 4, unlockLevel: 5 },
                    sushi: { name: "Sushi", icon: "üç£", buyPrice: 8, sellPrice: 20, stock: 5, unlockLevel: 7 }
                },
                customerTypes: [
                    { name: "Hungry Worker", avatar: "üßë‚Äçüíº", products: ["burger", "salad"], tip: 3 },
                    { name: "Family", avatar: "üë®‚Äçüë©‚Äçüëß", products: ["pizza", "pasta"], tip: 8 },
                    { name: "Health Nut", avatar: "üí™", products: ["salad"], tip: 2 },
                    { name: "Foodie", avatar: "üòã", products: ["pasta", "pizza", "sushi"], tip: 5 },
                    { name: "Fine Diner", avatar: "üé©", products: ["steak", "pasta"], tip: 10 }
                ]
            },
            shop: {
                name: "Convenience Store",
                icon: "üè™",
                products: {
                    snacks: { name: "Snacks", icon: "üçø", buyPrice: 2, sellPrice: 6, stock: 12, unlockLevel: 1 },
                    drinks: { name: "Drinks", icon: "ü•§", buyPrice: 1, sellPrice: 4, stock: 15, unlockLevel: 1 },
                    candy: { name: "Candy", icon: "üç¨", buyPrice: 1, sellPrice: 3, stock: 20, unlockLevel: 2 },
                    magazine: { name: "Magazine", icon: "üì∞", buyPrice: 3, sellPrice: 8, stock: 8, unlockLevel: 3 },
                    chips: { name: "Chips", icon: "ü•î", buyPrice: 2, sellPrice: 7, stock: 10, unlockLevel: 4 },
                    icecream: { name: "Ice Cream", icon: "üç¶", buyPrice: 3, sellPrice: 9, stock: 8, unlockLevel: 6 }
                },
                customerTypes: [
                    { name: "Kid", avatar: "üë¶", products: ["candy", "drinks", "icecream"], tip: 1 },
                    { name: "Teenager", avatar: "üßë", products: ["snacks", "drinks", "chips"], tip: 2 },
                    { name: "Commuter", avatar: "üö∂", products: ["magazine", "drinks"], tip: 2 },
                    { name: "Movie Goer", avatar: "üé¨", products: ["snacks", "candy", "drinks"], tip: 3 }
                ]
            },
            supermarket: {
                name: "Grocery Store",
                icon: "üõí",
                products: {
                    bread: { name: "Bread", icon: "üçû", buyPrice: 2, sellPrice: 5, stock: 15, unlockLevel: 1 },
                    milk: { name: "Milk", icon: "ü•õ", buyPrice: 3, sellPrice: 7, stock: 12, unlockLevel: 1 },
                    eggs: { name: "Eggs", icon: "ü•ö", buyPrice: 3, sellPrice: 8, stock: 10, unlockLevel: 2 },
                    fruit: { name: "Fruit", icon: "üçé", buyPrice: 2, sellPrice: 6, stock: 18, unlockLevel: 3 },
                    cheese: { name: "Cheese", icon: "üßÄ", buyPrice: 4, sellPrice: 10, stock: 8, unlockLevel: 4 },
                    meat: { name: "Meat", icon: "ü•©", buyPrice: 6, sellPrice: 15, stock: 6, unlockLevel: 6 }
                },
                customerTypes: [
                    { name: "Mom Shopping", avatar: "üë©", products: ["bread", "milk", "eggs"], tip: 4 },
                    { name: "College Student", avatar: "üë®‚Äçüéì", products: ["bread", "milk"], tip: 2 },
                    { name: "Health Conscious", avatar: "üßò", products: ["fruit", "milk"], tip: 3 },
                    { name: "Weekly Shopper", avatar: "üõçÔ∏è", products: ["bread", "eggs", "fruit", "cheese"], tip: 5 },
                    { name: "Chef Shopping", avatar: "üë®‚Äçüç≥", products: ["meat", "cheese"], tip: 7 }
                ]
            },
            mailman: {
                name: "Post Office",
                icon: "üì¶",
                products: {
                    letter: { name: "Letter", icon: "‚úâÔ∏è", buyPrice: 1, sellPrice: 3, stock: 25, unlockLevel: 1 },
                    package: { name: "Package", icon: "üì¶", buyPrice: 3, sellPrice: 8, stock: 12, unlockLevel: 1 },
                    express: { name: "Express Mail", icon: "‚ö°", buyPrice: 5, sellPrice: 15, stock: 8, unlockLevel: 3 },
                    postcard: { name: "Postcard", icon: "üñºÔ∏è", buyPrice: 1, sellPrice: 4, stock: 20, unlockLevel: 2 },
                    priority: { name: "Priority Mail", icon: "üöÄ", buyPrice: 8, sellPrice: 20, stock: 5, unlockLevel: 5 },
                    international: { name: "International", icon: "üåç", buyPrice: 10, sellPrice: 25, stock: 4, unlockLevel: 7 }
                },
                customerTypes: [
                    { name: "Business Person", avatar: "üíº", products: ["express", "letter", "priority"], tip: 5 },
                    { name: "Online Shopper", avatar: "üõçÔ∏è", products: ["package"], tip: 3 },
                    { name: "Grandparent", avatar: "üë¥", products: ["letter", "postcard"], tip: 2 },
                    { name: "Vacationer", avatar: "üèñÔ∏è", products: ["postcard", "letter"], tip: 4 },
                    { name: "Global Trader", avatar: "üåê", products: ["international", "priority"], tip: 8 }
                ]
            },
            farmer: {
                name: "Farmers Market",
                icon: "üåΩ",
                products: {
                    corn: { name: "Corn", icon: "üåΩ", buyPrice: 2, sellPrice: 6, stock: 15, unlockLevel: 1 },
                    tomato: { name: "Tomatoes", icon: "üçÖ", buyPrice: 2, sellPrice: 7, stock: 12, unlockLevel: 1 },
                    wheat: { name: "Wheat", icon: "üåæ", buyPrice: 3, sellPrice: 8, stock: 10, unlockLevel: 2 },
                    carrot: { name: "Carrots", icon: "ü•ï", buyPrice: 1, sellPrice: 5, stock: 18, unlockLevel: 3 },
                    pumpkin: { name: "Pumpkin", icon: "üéÉ", buyPrice: 4, sellPrice: 12, stock: 8, unlockLevel: 4 },
                    strawberry: { name: "Strawberries", icon: "üçì", buyPrice: 5, sellPrice: 14, stock: 7, unlockLevel: 6 }
                },
                customerTypes: [
                    { name: "Chef", avatar: "üë®‚Äçüç≥", products: ["tomato", "corn"], tip: 6 },
                    { name: "Market Vendor", avatar: "üßë‚Äçüíº", products: ["wheat", "carrot", "corn"], tip: 8 },
                    { name: "Health Enthusiast", avatar: "ü•ó", products: ["tomato", "carrot", "strawberry"], tip: 4 },
                    { name: "Baker", avatar: "üçû", products: ["wheat", "pumpkin"], tip: 5 }
                ]
            }
        };

        const upgrades = [
            { id: "betterEquipment", name: "Better Equipment", description: "Increase all sale prices by 20%", cost: 200, icon: "‚öôÔ∏è" },
            { id: "marketing", name: "Marketing Campaign", description: "Customers arrive 30% faster", cost: 150, icon: "üì¢" },
            { id: "automation", name: "Automation System", description: "10% chance of instant service", cost: 300, icon: "ü§ñ" },
            { id: "bigStorage", name: "Big Storage", description: "Buy 10x stock at once for cheaper", cost: 250, icon: "üì¶" },
            { id: "vipLounge", name: "VIP Lounge", description: "VIP customers with 2x tips appear", cost: 400, icon: "üëë" },
            { id: "speedService", name: "Speed Service", description: "Customers have 50% more patience", cost: 350, icon: "‚ö°" }
        ];

        // Random events
        const randomEvents = [
            { name: "üéâ Rush Hour!", msg: "Double customers for 30 seconds!", duration: 30000, effect: 'rush' },
            { name: "‚≠ê VIP Visit!", msg: "A VIP customer with big tips arrived!", duration: 0, effect: 'vip' },
            { name: "üì∞ Great Review!", msg: "+15 reputation!", duration: 0, effect: 'review' },
            { name: "üí∞ Tip Jar Bonus!", msg: "Found $50 in the tip jar!", duration: 0, effect: 'tipjar' },
            { name: "üéÅ Bulk Delivery!", msg: "+5 stock to all items!", duration: 0, effect: 'bulk' },
            { name: "üò§ Bad Review!", msg: "-10 reputation!", duration: 0, effect: 'badreview' }
        ];

        function startJob(jobType) {
            gameState.currentJob = jobType;
            gameState.inventory = {};
            gameState.unlockedProducts = [];

            if (jobType === 'all') {
                // Load ALL jobs' products
                for (let jt in jobs) {
                    const job = jobs[jt];
                    for (let productId in job.products) {
                        if (!gameState.inventory[productId]) {
                            gameState.inventory[productId] = { ...job.products[productId], fromJob: jt };
                            if (job.products[productId].unlockLevel === 1) {
                                gameState.unlockedProducts.push(productId);
                            }
                        }
                    }
                }
            } else {
                const job = jobs[jobType];
                for (let productId in job.products) {
                    gameState.inventory[productId] = { ...job.products[productId] };
                    if (job.products[productId].unlockLevel === 1) {
                        gameState.unlockedProducts.push(productId);
                    }
                }
            }

            document.getElementById('jobSelection').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';

            updateUI();
            renderInventory();
            renderUpgrades();
            startCustomerSpawning();
        }

        function startCustomerSpawning() {
            const baseInterval = gameState.upgrades.marketing ? 4000 : 6000;

            setInterval(() => {
                if (gameState.customers.length < 4) {
                    spawnCustomer();
                }
            }, baseInterval);

            // Random events every 30-60s
            setInterval(() => {
                if (Math.random() < 0.5) triggerRandomEvent();
            }, 30000);

            // Day counter every 60s
            setInterval(() => advanceDay(), 60000);

            // Spawn first customer immediately
            setTimeout(() => spawnCustomer(), 1000);
        }

        function spawnCustomer() {
            let customerType;
            if (gameState.currentJob === 'all') {
                const allTypes = [];
                for (let jt in jobs) for (let ct of jobs[jt].customerTypes) allTypes.push(ct);
                customerType = allTypes[Math.floor(Math.random() * allTypes.length)];
            } else {
                const job = jobs[gameState.currentJob];
                customerType = job.customerTypes[Math.floor(Math.random() * job.customerTypes.length)];
            }

            const requestedProducts = [];
            const numProducts = Math.floor(Math.random() * 2) + 1;

            for (let i = 0; i < numProducts; i++) {
                const productId = customerType.products[Math.floor(Math.random() * customerType.products.length)];
                // Only request unlocked products
                if (!requestedProducts.includes(productId) && gameState.unlockedProducts.includes(productId)) {
                    requestedProducts.push(productId);
                }
            }

            // Skip if no valid products
            if (requestedProducts.length === 0) {
                return;
            }

            const customer = {
                id: gameState.customerIdCounter++,
                name: customerType.name,
                avatar: customerType.avatar,
                requestedProducts: requestedProducts,
                tip: customerType.tip,
                patience: 100,
                patienceTimer: null
            };

            gameState.customers.push(customer);

            // Start patience timer
            const patienceRate = gameState.upgrades.speedService ? 3000 : 2000;
            customer.patienceTimer = setInterval(() => {
                customer.patience -= 5;
                renderCustomers();
                if (customer.patience <= 0) {
                    removeCustomer(customer.id, true);
                }
            }, patienceRate);

            renderCustomers();
        }

        // Random events
        function triggerRandomEvent() {
            const evt = randomEvents[Math.floor(Math.random() * randomEvents.length)];
            sfx('event');
            const banner = document.getElementById('event-banner');
            banner.textContent = evt.name + ' ' + evt.msg;
            banner.style.display = 'block';
            setTimeout(() => { banner.style.display = 'none'; }, 4000);

            switch(evt.effect) {
                case 'rush':
                    for (let i = 0; i < 3; i++) setTimeout(() => spawnCustomer(), i * 1000);
                    break;
                case 'vip': {
                    const job = jobs[gameState.currentJob];
                    const ct = job.customerTypes[Math.floor(Math.random() * job.customerTypes.length)];
                    const prods = ct.products.filter(p => gameState.unlockedProducts.includes(p));
                    if (prods.length > 0) {
                        const c = { id: gameState.customerIdCounter++, name: 'üëë VIP ' + ct.name, avatar: 'üëë',
                            requestedProducts: [prods[Math.floor(Math.random()*prods.length)]],
                            tip: ct.tip * 3, patience: 100, patienceTimer: null };
                        gameState.customers.push(c);
                        const pr = gameState.upgrades.speedService ? 3000 : 2000;
                        c.patienceTimer = setInterval(() => { c.patience -= 5; renderCustomers(); if(c.patience<=0) removeCustomer(c.id,true); }, pr);
                        renderCustomers();
                    }
                    break;
                }
                case 'review':
                    gameState.reputation = Math.min(100, gameState.reputation + 15);
                    updateUI();
                    break;
                case 'tipjar':
                    gameState.money += 50;
                    sfx('coin');
                    updateUI();
                    break;
                case 'bulk':
                    for (let pid of gameState.unlockedProducts) {
                        gameState.inventory[pid].stock += 5;
                    }
                    renderInventory();
                    break;
                case 'badreview':
                    gameState.reputation = Math.max(0, gameState.reputation - 10);
                    updateUI();
                    break;
            }
        }

        // Day counter
        function advanceDay() {
            gameState.dayCount++;
            updateUI();
        }

        function serveCustomer(customerId) {
            const customer = gameState.customers.find(c => c.id === customerId);
            if (!customer) return;

            // Check if we have all products
            let canServe = true;
            let totalCost = 0;

            for (let productId of customer.requestedProducts) {
                if (!gameState.inventory[productId] || gameState.inventory[productId].stock <= 0) {
                    canServe = false;
                    break;
                }
                let sellPrice = gameState.inventory[productId].sellPrice;
                if (gameState.upgrades.betterEquipment) {
                    sellPrice *= 1.2;
                }
                totalCost += sellPrice;
            }

            if (!canServe) {
                showMessage("Not enough stock!", "error");
                sfx('fail');
                return;
            }

            sfx('sell');

            // Check for automation instant service
            if (gameState.upgrades.automation && Math.random() < 0.1) {
                showMessage("Automation bonus! Instant service!", "info");
            }

            // Deduct inventory
            for (let productId of customer.requestedProducts) {
                gameState.inventory[productId].stock--;
            }

            // Combo system
            gameState.combo++;
            clearTimeout(gameState.comboTimer);
            gameState.comboTimer = setTimeout(() => { gameState.combo = 0; updateUI(); }, 5000);
            const comboBonus = gameState.combo > 1 ? Math.floor(gameState.combo * 2) : 0;
            if (gameState.combo >= 3) sfx('combo');

            // Add money and tip
            const tip = customer.patience > 70 ? customer.tip : Math.floor(customer.tip / 2);
            const earned = Math.round(totalCost + tip + comboBonus);
            gameState.money += earned;
            gameState.totalEarned += earned;
            gameState.customersServed++;

            // XP system
            const xpGain = customer.requestedProducts.length + (customer.patience > 80 ? 1 : 0);
            gameState.xp += xpGain;
            if (gameState.xp >= gameState.xpNeeded) {
                gameState.xp -= gameState.xpNeeded;
                gameState.level++;
                gameState.xpNeeded = Math.floor(gameState.xpNeeded * 1.4);
                checkUnlocks();
                sfx('levelup');
                showMessage(`LEVEL UP! Level ${gameState.level}! üéâ`, "success");
            }

            // Increase reputation
            gameState.reputation = Math.min(100, gameState.reputation + 2);

            let msg = `+$${earned}`;
            if (comboBonus > 0) msg += ` (Combo x${gameState.combo}: +$${comboBonus})`;
            showMessage(msg, "success");
            removeCustomer(customerId, false);
            updateUI();
            renderInventory();
        }

        function checkUnlocks() {
            let newUnlocks = [];
            const jobsToCheck = gameState.currentJob === 'all' ? Object.keys(jobs) : [gameState.currentJob];

            for (let jt of jobsToCheck) {
                const job = jobs[jt];
                for (let productId in job.products) {
                    const product = job.products[productId];
                    if (product.unlockLevel <= gameState.level && !gameState.unlockedProducts.includes(productId)) {
                        gameState.unlockedProducts.push(productId);
                        newUnlocks.push(product.name);
                    }
                }
            }

            if (newUnlocks.length > 0) {
                setTimeout(() => {
                    showMessage(`New Recipe Unlocked: ${newUnlocks.join(', ')}! üéä`, "success");
                }, 2500);
            }
        }

        function removeCustomer(customerId, timeout = false) {
            const customerIndex = gameState.customers.findIndex(c => c.id === customerId);
            if (customerIndex === -1) return;

            const customer = gameState.customers[customerIndex];

            if (customer.patienceTimer) {
                clearInterval(customer.patienceTimer);
            }

            if (timeout) {
                gameState.reputation = Math.max(0, gameState.reputation - 5);
                showMessage("Customer left unhappy!", "error");
                updateUI();
            }

            gameState.customers.splice(customerIndex, 1);
            renderCustomers();
        }

        function buyProduct(productId, amount = 1) {
            const product = gameState.inventory[productId];
            let cost = product.buyPrice * amount;
            if (amount >= 10 && gameState.upgrades.bigStorage) cost = Math.floor(cost * 0.8);

            if (gameState.money < cost) {
                showMessage("Not enough money!", "error");
                sfx('fail');
                return;
            }

            gameState.money -= cost;
            product.stock += amount;
            sfx('buy');

            showMessage(`Bought ${amount}x ${product.name} (-$${cost})`, "info");
            updateUI();
            renderInventory();
        }

        function buyUpgrade(upgradeId) {
            const upgrade = upgrades.find(u => u.id === upgradeId);
            if (!upgrade || gameState.upgrades[upgradeId]) return;

            if (gameState.money < upgrade.cost) {
                showMessage("Not enough money!", "error");
                sfx('fail');
                return;
            }

            gameState.money -= upgrade.cost;
            gameState.upgrades[upgradeId] = true;
            sfx('upgrade');

            showMessage(`Purchased ${upgrade.name}!`, "success");
            updateUI();
            renderUpgrades();
            renderInventory();
        }

        function renderCustomers() {
            const customerList = document.getElementById('customerList');

            if (gameState.customers.length === 0) {
                customerList.innerHTML = '<div class="no-customers">Waiting for customers...</div>';
                return;
            }

            customerList.innerHTML = gameState.customers.map(customer => {
                const products = customer.requestedProducts.map(productId => {
                    const product = gameState.inventory[productId];
                    return `${product.icon} ${product.name}`;
                }).join(', ');

                const canServe = customer.requestedProducts.every(productId =>
                    gameState.inventory[productId] && gameState.inventory[productId].stock > 0
                );

                return `
                    <div class="customer">
                        <div class="customer-info">
                            <div class="customer-avatar">${customer.avatar}</div>
                            <div class="customer-details">
                                <h3>${customer.name}</h3>
                                <div style="color: ${customer.patience > 50 ? '#28a745' : '#dc3545'}; font-size: 12px;">
                                    Patience: ${customer.patience}%
                                </div>
                            </div>
                        </div>
                        <div class="customer-request">
                            "I'd like: ${products}"
                        </div>
                        <div class="customer-actions">
                            <button class="btn btn-serve" onclick="serveCustomer(${customer.id})" ${!canServe ? 'disabled' : ''}>
                                Serve Customer
                            </button>
                            <button class="btn btn-ignore" onclick="removeCustomer(${customer.id}, false)">
                                Ignore
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderInventory() {
            const inventoryList = document.getElementById('inventoryList');

            const sortedProducts = Object.keys(gameState.inventory).sort((a, b) => {
                const aOwned = gameState.unlockedProducts.includes(a) ? 0 : 1;
                const bOwned = gameState.unlockedProducts.includes(b) ? 0 : 1;
                return aOwned - bOwned;
            });
            inventoryList.innerHTML = sortedProducts.map(productId => {
                const product = gameState.inventory[productId];
                const isUnlocked = gameState.unlockedProducts.includes(productId);
                let sellPrice = product.sellPrice;
                if (gameState.upgrades.betterEquipment) {
                    sellPrice = Math.round(sellPrice * 1.2);
                }

                if (!isUnlocked) {
                    return `
                        <div class="inventory-item" style="opacity: 0.5; border-color: #ccc;">
                            <div class="item-header">
                                <div class="item-name">üîí ${product.name}</div>
                                <div class="item-stock" style="color: #999;">Level ${product.unlockLevel}</div>
                            </div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 10px;">
                                Unlock at Level ${product.unlockLevel}
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="inventory-item">
                        <div class="item-header">
                            <div class="item-name">${product.icon} ${product.name}</div>
                            <div class="item-stock">Stock: ${product.stock}</div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                            Sell: $${sellPrice} | Buy: $${product.buyPrice}
                        </div>
                        <div class="item-actions">
                            <button class="btn-small" onclick="buyProduct('${productId}', 1)">Buy 1</button>
                            <button class="btn-small" onclick="buyProduct('${productId}', 5)">Buy 5</button>
                            ${gameState.upgrades.bigStorage ? `<button class="btn-small" onclick="buyProduct('${productId}', 10)" style="background:#28a745">Buy 10 (-20%)</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderUpgrades() {
            const upgradesList = document.getElementById('upgradesList');

            const sortedUpgrades = [...upgrades].sort((a, b) => {
                const aOwned = gameState.upgrades[a.id] ? 0 : 1;
                const bOwned = gameState.upgrades[b.id] ? 0 : 1;
                return aOwned - bOwned;
            });
            upgradesList.innerHTML = sortedUpgrades.map(upgrade => {
                const owned = gameState.upgrades[upgrade.id];

                return `
                    <div class="upgrade-item" style="${owned ? 'border-color: #28a745; background: #f0fff0;' : ''}">
                        <div class="upgrade-info">
                            <div class="upgrade-name">${upgrade.icon} ${upgrade.name}</div>
                            <div class="upgrade-description">${upgrade.description}</div>
                        </div>
                        <button class="btn btn-serve" onclick="buyUpgrade('${upgrade.id}')" ${owned ? 'disabled' : ''}>
                            ${owned ? 'Owned' : `$${upgrade.cost}`}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function updateUI() {
            document.getElementById('money').textContent = Math.round(gameState.money);
            document.getElementById('reputation').textContent = gameState.reputation;
            document.getElementById('customersServed').textContent = gameState.customersServed;
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('combo').textContent = gameState.combo;
            document.getElementById('dayCount').textContent = gameState.dayCount;
            document.getElementById('xp-bar').style.width = (gameState.xp / gameState.xpNeeded * 100) + '%';
            document.getElementById('xp-text').textContent = gameState.xp + '/' + gameState.xpNeeded;
        }

        function showMessage(text, type) {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            document.body.appendChild(message);

            setTimeout(() => {
                message.remove();
            }, 2000);
        }
    </script>
</body>
</html>
